# 📋 EDM系统V2.0核心功能测试用例

## 🎯 测试用例概览

### 📌 测试范围
- V2.0独立任务创建和管理
- SubTask生成和跟踪机制
- 用户额度管理验证
- 收件人规则处理
- 邮件跟踪统计（待开发完成）

### ⚠️ 测试状态：等待开发完成
**阻塞原因**: F05邮件跟踪统计功能未完整实现

## 📋 测试用例列表

### 🎯 TC-V2.0-TASK-001: 独立任务创建

#### TC-V2.0-TASK-001-01: 基础任务创建
- **优先级**: P0
- **描述**: 验证V2.0独立任务创建功能，不依赖Campaign
- **前置条件**: 
  - 用户已登录
  - 至少有1个发信人、1个发信服务、1个模板集
  - 至少有1个联系人
- **测试步骤**:
  1. 发送POST请求到 `/api/tasks`
  2. 提供完整的任务数据
  ```json
  {
    "name": "V2.0独立测试任务",
    "description": "测试V2.0独立任务创建",
    "schedule_time": "2024-12-10T10:00:00Z",
    "recipient_rule": {
      "type": "specific",
      "contact_ids": ["contact-uuid-1"]
    },
    "template_set_id": "template-set-uuid",
    "sender_id": "sender-uuid",
    "email_service_id": "email-service-uuid"
  }
  ```
- **预期结果**:
  - 响应状态码: 201
  - 响应包含任务ID和详细信息
  - 任务状态为 'draft'
  - 任务不包含 campaign_id 字段
  - created_by 为当前用户ID

#### TC-V2.0-TASK-001-02: 必需字段验证
- **优先级**: P0
- **描述**: 验证创建任务时必需字段的验证机制
- **测试数据**: 
  - 缺少 name 字段
  - 缺少 sender_id 字段
  - 缺少 email_service_id 字段
  - 缺少 template_set_id 字段
  - 缺少 recipient_rule 字段
- **预期结果**: 
  - 响应状态码: 400
  - 返回详细的字段验证错误信息

#### TC-V2.0-TASK-001-03: 权限验证
- **优先级**: P0
- **描述**: 验证用户只能使用属于自己的资源
- **测试场景**:
  - 使用其他用户的发信人
  - 使用其他用户的模板集
  - 使用不存在的资源ID
- **预期结果**: 
  - 响应状态码: 404 或 403
  - 返回权限错误信息

### 🎯 TC-V2.0-TASK-002: 收件人规则处理

#### TC-V2.0-TASK-002-01: 指定联系人规则
- **优先级**: P0
- **描述**: 验证 specific 类型的收件人规则
- **测试数据**:
  ```json
  {
    "recipient_rule": {
      "type": "specific",
      "contact_ids": ["uuid1", "uuid2", "uuid3"]
    }
  }
  ```
- **预期结果**: 
  - 任务创建成功
  - 系统正确计算收件人数量
  - summary_stats.total_recipients 等于联系人数量

#### TC-V2.0-TASK-002-02: 标签筛选规则
- **优先级**: P0
- **描述**: 验证 tag_based 类型的收件人规则
- **测试数据**:
  ```json
  {
    "recipient_rule": {
      "type": "tag_based",
      "include_tags": ["VIP客户", "活跃用户"],
      "exclude_tags": ["已退订"]
    }
  }
  ```
- **预期结果**: 
  - 任务创建成功
  - 系统正确筛选联系人
  - 排除包含"已退订"标签的联系人

#### TC-V2.0-TASK-002-03: 全部联系人规则
- **优先级**: P1
- **描述**: 验证 all_contacts 类型的收件人规则
- **测试数据**:
  ```json
  {
    "recipient_rule": {
      "type": "all_contacts"
    }
  }
  ```
- **预期结果**: 
  - 任务创建成功
  - 包含系统中所有联系人
  - 正确计算总数量

### 🎯 TC-V2.0-TASK-003: 用户额度验证

#### TC-V2.0-TASK-003-01: 额度充足情况
- **优先级**: P0
- **描述**: 验证用户额度充足时任务创建成功
- **前置条件**: 用户剩余额度 > 所需发送数量
- **预期结果**: 
  - 任务创建成功
  - 不显示额度不足错误

#### TC-V2.0-TASK-003-02: 额度不足情况
- **优先级**: P0
- **描述**: 验证用户额度不足时任务创建失败
- **前置条件**: 用户剩余额度 < 所需发送数量
- **预期结果**: 
  - 响应状态码: 400
  - 返回额度不足错误信息
  - 任务未创建

#### TC-V2.0-TASK-003-03: 额度边界测试
- **优先级**: P1
- **描述**: 验证额度恰好等于所需数量的情况
- **前置条件**: 用户剩余额度 = 所需发送数量
- **预期结果**: 
  - 任务创建成功
  - 额度验证通过

### 🎯 TC-V2.0-TASK-004: 任务管理操作

#### TC-V2.0-TASK-004-01: 任务列表查询
- **优先级**: P0
- **描述**: 验证用户任务列表查询功能
- **测试步骤**:
  1. 发送GET请求到 `/api/tasks`
  2. 验证分页参数
  3. 验证筛选参数
- **预期结果**: 
  - 返回用户的任务列表
  - 支持分页
  - 支持状态筛选

#### TC-V2.0-TASK-004-02: 任务详情查询
- **优先级**: P0
- **描述**: 验证单个任务详情查询
- **预期结果**: 
  - 返回完整任务信息
  - 包含关联的发信人、发信服务、模板集信息
  - 包含统计数据

#### TC-V2.0-TASK-004-03: 任务状态更新
- **优先级**: P0
- **描述**: 验证任务状态转换
- **测试场景**:
  - draft → scheduled
  - scheduled → sending
  - sending → paused
  - paused → sending
  - sending → completed
- **预期结果**: 
  - 状态更新成功
  - 不允许非法状态转换

#### TC-V2.0-TASK-004-04: 任务删除
- **优先级**: P1
- **描述**: 验证任务删除功能
- **前置条件**: 任务状态为 draft 或 cancelled
- **预期结果**: 
  - 删除成功
  - 相关SubTask也被删除

### 🎯 TC-V2.0-SUBTASK-001: SubTask生成机制

#### TC-V2.0-SUBTASK-001-01: SubTask自动生成
- **优先级**: P0
- **描述**: 验证任务调度时SubTask自动生成
- **测试步骤**:
  1. 创建任务
  2. 将任务状态设为 scheduled
  3. 等待SubTask生成
- **预期结果**: 
  - 为每个联系人生成一个SubTask
  - SubTask包含渲染后的邮件内容
  - SubTask状态为 pending

#### TC-V2.0-SUBTASK-001-02: 模板内容渲染
- **优先级**: P0
- **描述**: 验证模板内容个性化渲染
- **测试数据**: 
  - 模板包含变量: "您好 {{name}}，感谢您的关注！"
  - 联系人姓名: "张三"
- **预期结果**: 
  - rendered_subject 和 rendered_body 正确替换变量
  - 渲染后内容: "您好 张三，感谢您的关注！"

#### TC-V2.0-SUBTASK-001-03: 发信人邮箱组装
- **优先级**: P0
- **描述**: 验证发信人邮箱正确组装
- **测试数据**: 
  - 发信人: "support"
  - 发信服务域名: "company.com"
- **预期结果**: 
  - sender_email 为 "support@company.com"
  - recipient_email 为联系人邮箱

### 🎯 TC-V2.0-SUBTASK-002: SubTask查询和管理

#### TC-V2.0-SUBTASK-002-01: 任务SubTask列表
- **优先级**: P0
- **描述**: 验证查询任务的SubTask列表
- **测试步骤**:
  1. 发送GET请求到 `/api/tasks/{task_id}/subtasks`
  2. 验证分页和筛选
- **预期结果**: 
  - 返回该任务的所有SubTask
  - 支持状态筛选
  - 支持分页

#### TC-V2.0-SUBTASK-002-02: SubTask状态跟踪
- **优先级**: P0
- **描述**: 验证SubTask状态正确跟踪
- **状态流程**: pending → sent → delivered → opened → clicked
- **预期结果**: 
  - 状态转换合法
  - 时间戳正确记录

### 🎯 TC-V2.0-ANALYTICS-001: 统计分析功能 ⚠️ 等待开发

#### TC-V2.0-ANALYTICS-001-01: 打开率跟踪
- **优先级**: P0
- **描述**: 验证邮件打开透明像素跟踪
- **状态**: ❌ 阻塞 - 需要开发完成跟踪与V2.0集成
- **测试步骤**: 
  1. 邮件发送成功
  2. 模拟邮件客户端请求跟踪像素
  3. 验证SubTask状态更新为 opened
  4. 验证Task统计数据更新

#### TC-V2.0-ANALYTICS-001-02: 点击率跟踪
- **优先级**: P0
- **描述**: 验证邮件链接点击跟踪
- **状态**: ❌ 阻塞 - 需要开发完成跟踪与V2.0集成
- **测试步骤**: 
  1. 邮件包含跟踪链接
  2. 模拟用户点击链接
  3. 验证SubTask状态更新为 clicked
  4. 验证正确跳转到目标页面

#### TC-V2.0-ANALYTICS-001-03: 统计数据聚合
- **优先级**: P0
- **描述**: 验证Task级别统计数据正确聚合
- **状态**: ❌ 阻塞 - 需要开发完成统计聚合机制
- **预期结果**: 
  - Task.summary_stats 实时更新
  - 各项统计数据准确（发送数/送达数/打开数/点击数）

### 🎯 TC-V2.0-PERFORMANCE-001: 性能测试

#### TC-V2.0-PERFORMANCE-001-01: 大批量联系人任务
- **优先级**: P1
- **描述**: 验证1000+联系人任务处理性能
- **测试数据**: 1000个联系人的任务
- **性能要求**: 
  - 任务创建时间 < 5秒
  - SubTask生成时间 < 30秒
  - 内存使用合理

#### TC-V2.0-PERFORMANCE-001-02: 并发任务处理
- **优先级**: P1
- **描述**: 验证多个任务并发执行
- **测试数据**: 同时执行5个任务
- **性能要求**: 
  - 任务间不相互影响
  - 系统响应稳定

### 🎯 TC-V2.0-INTEGRATION-001: 第三方集成测试

#### TC-V2.0-INTEGRATION-001-01: 邮件服务集成
- **优先级**: P0
- **描述**: 验证与第三方邮件服务的集成
- **测试步骤**: 
  1. 配置真实邮件服务
  2. 发送测试邮件
  3. 验证发送状态回调
- **预期结果**: 
  - 邮件成功发送
  - 状态正确更新

## 📊 测试覆盖度矩阵

| 功能模块 | 已覆盖用例数 | 阻塞用例数 | 覆盖率 | 状态 |
|---------|-------------|-----------|--------|------|
| 独立任务创建 | 9 | 0 | 100% | ✅ 就绪 |
| 收件人规则 | 6 | 0 | 100% | ✅ 就绪 |
| 用户额度验证 | 3 | 0 | 100% | ✅ 就绪 |
| 任务管理 | 8 | 0 | 100% | ✅ 就绪 |
| SubTask生成 | 6 | 0 | 100% | ✅ 就绪 |
| 统计分析 | 0 | 8 | 0% | ❌ 阻塞 |
| 性能测试 | 4 | 0 | 80% | ⚠️ 部分就绪 |
| 第三方集成 | 2 | 0 | 70% | ⚠️ 部分就绪 |

## 🚨 测试阻塞问题

### ❌ P0阻塞（必须解决才能测试）
1. **F05统计分析功能未实现** - 8个测试用例无法执行
2. **跟踪数据与V2.0架构未集成** - 核心业务价值无法验证

### ⚠️ P1风险（影响测试质量）
1. **真实邮件服务配置** - 需要生产级配置进行测试
2. **大数据量测试环境** - 需要准备充足的测试数据

## 📋 测试数据准备

### 基础测试数据
- **用户**: 3个测试用户（管理员、普通用户、受限用户）
- **联系人**: 1000个测试联系人，包含各种标签组合
- **发信人**: 每用户5个发信人
- **邮件模板**: 10个不同类型的模板
- **发信服务**: 3个配置好的邮件服务

### 边界测试数据
- **极大任务**: 10000个联系人
- **极小任务**: 1个联系人
- **复杂标签规则**: 多层嵌套标签组合
- **特殊字符**: 邮件内容包含各种特殊字符

---

## 🚨 测试负责人评估

**当前测试用例完整性**: 72%

**阻塞情况**:
- ❌ **F05统计分析功能** - 占核心业务价值40%，必须开发完成
- ❌ **跟踪与V2.0架构集成** - 架构一致性问题，必须解决

**建议**: 
1. 暂停测试执行，等待开发完成F05功能
2. 优先完成跟踪统计与V2.0架构集成
3. 开发完成后，预计需要增加15个统计相关测试用例

---

*📝 测试用例编写者: AI测试专家*  
*📅 文档创建时间: V2.0架构重构后*  
*🎯 适用版本: V2.0核心功能*  
*⚠️ 状态: 部分就绪，等待开发完成* 