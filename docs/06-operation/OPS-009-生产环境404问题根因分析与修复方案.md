# OPS-009-ç”Ÿäº§ç¯å¢ƒ404é—®é¢˜æ ¹å› åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**é—®é¢˜**: ç”Ÿäº§ç¯å¢ƒ `https://tkmail.fun/tags` ç­‰Reactè·¯ç”±è¿”å›404é”™è¯¯
**å½±å“**: ç”¨æˆ·æ— æ³•ç›´æ¥è®¿é—®åº”ç”¨å†…é¡µé¢ï¼Œåªèƒ½ä»é¦–é¡µå¯¼èˆª
**ç´§æ€¥ç¨‹åº¦**: é«˜ - å½±å“ç”¨æˆ·ä½“éªŒ

## ğŸ” æ ¹å› åˆ†æ

### 1. é—®é¢˜ç°è±¡
- ç›´æ¥è®¿é—® `https://tkmail.fun/tags` è¿”å›404
- ä»é¦–é¡µç‚¹å‡»å¯¼èˆªå¯ä»¥æ­£å¸¸è®¿é—®æ ‡ç­¾é¡µé¢
- APIæ¥å£ `/api/*` æ­£å¸¸å·¥ä½œ
- é¦–é¡µ `https://tkmail.fun/` æ­£å¸¸è®¿é—®

### 2. æŠ€æœ¯åˆ†æ

#### ğŸ¯ æ ¹æœ¬åŸå› 
**nginxé…ç½®ä¸­çš„server_nameä¸åŒ¹é…å®é™…åŸŸå**

```nginx
# é”™è¯¯é…ç½®
server_name edm.yourdomain.com;  # âŒ ä¸åŒ¹é…å®é™…åŸŸå

# æ­£ç¡®é…ç½®  
server_name tkmail.fun;          # âœ… åŒ¹é…å®é™…åŸŸå
```

#### ğŸ”„ é—®é¢˜æœºåˆ¶
1. ç”¨æˆ·è®¿é—® `https://tkmail.fun/tags`
2. nginxæ”¶åˆ°è¯·æ±‚ï¼Œä½†server_nameä¸åŒ¹é…
3. è¯·æ±‚è½åˆ°é»˜è®¤serverå—æˆ–è¢«æ‹’ç»
4. æ²¡æœ‰æ­£ç¡®çš„React SPAè·¯ç”±å›é€€æœºåˆ¶
5. è¿”å›404é”™è¯¯

#### ğŸ“Š å¯¹æ¯”åˆ†æ

| é…ç½®é¡¹ | é”™è¯¯é…ç½® | æ­£ç¡®é…ç½® | å½±å“ |
|--------|----------|----------|------|
| server_name | edm.yourdomain.com | tkmail.fun | è¯·æ±‚è·¯ç”±åŒ¹é… |
| é˜²ç›—é“¾é…ç½® | *.yourdomain.com | *.tkmail.fun | èµ„æºè®¿é—®æ§åˆ¶ |
| SPAè·¯ç”±å›é€€ | ä¾èµ–serveråŒ¹é… | ç‹¬ç«‹å·¥ä½œ | å‰ç«¯è·¯ç”±æ”¯æŒ |

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. é…ç½®æ–‡ä»¶ä¿®å¤

#### nginx.production.conf æ›´æ–°
```nginx
# ä¿®å¤server_name
server_name tkmail.fun;

# ä¿®å¤é˜²ç›—é“¾é…ç½®
valid_referers none blocked server_names *.tkmail.fun tkmail.fun;
```

#### React SPAè·¯ç”±æ”¯æŒç¡®è®¤
```nginx
# ç¡®ä¿Reactè·¯ç”±å›é€€æ­£å¸¸å·¥ä½œ
location @fallback {
    proxy_pass http://frontend/;
    proxy_set_header Host $host;
    # ... å…¶ä»–é…ç½®
}
```

### 2. éƒ¨ç½²è„šæœ¬

åˆ›å»ºè‡ªåŠ¨åŒ–ä¿®å¤è„šæœ¬ï¼š`deploy/scripts/fix-404-production.sh`

**è„šæœ¬åŠŸèƒ½**:
- å¤‡ä»½å½“å‰é…ç½®
- æ›´æ–°nginxé…ç½®
- é‡å¯nginxæœåŠ¡
- éªŒè¯é…ç½®æ­£ç¡®æ€§
- æµ‹è¯•è·¯ç”±è®¿é—®

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
# åœ¨EDMé¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
./deploy/scripts/fix-404-production.sh
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ“ä½œ
```bash
# 1. å¤‡ä»½é…ç½®
mkdir -p deploy/nginx/backup/$(date +%Y%m%d_%H%M%S)

# 2. æ›´æ–°é…ç½®
cp deploy/nginx/nginx.production.conf deploy/nginx/nginx.conf

# 3. é‡å¯æœåŠ¡
docker-compose restart nginx

# 4. éªŒè¯é…ç½®
docker exec $(docker ps --filter name=nginx --format '{{.Names}}' | head -1) nginx -t

# 5. é‡æ–°åŠ è½½
docker exec $(docker ps --filter name=nginx --format '{{.Names}}' | head -1) nginx -s reload
```

## âœ… éªŒè¯æµ‹è¯•

### 1. åŸºæœ¬è®¿é—®æµ‹è¯•
```bash
# æµ‹è¯•é¦–é¡µ
curl -I https://tkmail.fun/

# æµ‹è¯•Reactè·¯ç”±
curl -I https://tkmail.fun/tags
curl -I https://tkmail.fun/contacts
curl -I https://tkmail.fun/campaigns

# æµ‹è¯•API
curl -I https://tkmail.fun/api/health
```

### 2. æµè§ˆå™¨æµ‹è¯•
- [ ] ç›´æ¥è®¿é—® `https://tkmail.fun/tags`
- [ ] ç›´æ¥è®¿é—® `https://tkmail.fun/contacts`
- [ ] ç›´æ¥è®¿é—® `https://tkmail.fun/campaigns`
- [ ] åˆ·æ–°é¡µé¢åŠŸèƒ½æ­£å¸¸
- [ ] å‰ç«¯è·¯ç”±å¯¼èˆªæ­£å¸¸

### 3. åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] APIè°ƒç”¨æ­£å¸¸
- [ ] é™æ€èµ„æºåŠ è½½æ­£å¸¸
- [ ] WebSocketè¿æ¥æ­£å¸¸ï¼ˆå¦‚æœ‰ï¼‰

## ğŸ“Š é¢„æœŸç»“æœ

ä¿®å¤ååº”è¯¥å®ç°ï¼š
- âœ… æ‰€æœ‰Reactè·¯ç”±ç›´æ¥è®¿é—®æ­£å¸¸
- âœ… é¡µé¢åˆ·æ–°ä¸ä¼š404
- âœ… SEOå‹å¥½çš„URLç»“æ„
- âœ… ç”¨æˆ·ä½“éªŒå®Œå…¨æ¢å¤

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœä¿®å¤å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# 1. åœæ­¢nginx
docker-compose stop nginx

# 2. æ¢å¤å¤‡ä»½é…ç½®
cp deploy/nginx/backup/[æœ€æ–°å¤‡ä»½]/nginx.conf.backup deploy/nginx/nginx.conf

# 3. é‡å¯nginx
docker-compose up -d nginx
```

## ğŸ“š ç»éªŒæ€»ç»“

### ğŸ¯ å…³é”®å­¦ä¹ ç‚¹
1. **åŸŸåé…ç½®ä¸€è‡´æ€§**: server_nameå¿…é¡»ä¸å®é™…åŸŸåå®Œå…¨åŒ¹é…
2. **SPAè·¯ç”±æ”¯æŒ**: Reactåº”ç”¨éœ€è¦nginxå±‚é¢çš„è·¯ç”±å›é€€æ”¯æŒ
3. **é…ç½®éªŒè¯**: æ¯æ¬¡é…ç½®å˜æ›´éƒ½è¦è¿›è¡Œå®Œæ•´æµ‹è¯•
4. **å¤‡ä»½ç­–ç•¥**: é‡è¦é…ç½®å˜æ›´å‰å¿…é¡»å¤‡ä»½

### ğŸ›¡ï¸ é¢„é˜²æªæ–½
1. **é…ç½®æ¨¡æ¿åŒ–**: ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†åŸŸåé…ç½®
2. **è‡ªåŠ¨åŒ–æµ‹è¯•**: éƒ¨ç½²åè‡ªåŠ¨éªŒè¯å…³é”®è·¯ç”±
3. **ç›‘æ§å‘Šè­¦**: è®¾ç½®404é”™è¯¯ç‡ç›‘æ§
4. **æ–‡æ¡£åŒæ­¥**: é…ç½®å˜æ›´åŠæ—¶æ›´æ–°æ–‡æ¡£

### ğŸ”§ åç»­ä¼˜åŒ–å»ºè®®
1. è€ƒè™‘ä½¿ç”¨Kubernetes ConfigMapç®¡ç†nginxé…ç½®
2. å®ç°è“ç»¿éƒ¨ç½²å‡å°‘æœåŠ¡ä¸­æ–­
3. æ·»åŠ nginxé…ç½®çš„CI/CDéªŒè¯
4. å»ºç«‹é…ç½®å˜æ›´çš„å®¡æ‰¹æµç¨‹

---

**ä¿®å¤æ‰§è¡Œäºº**: AI Agent  
**ä¿®å¤æ—¶é—´**: 2025-06-26  
**éªŒè¯çŠ¶æ€**: å¾…æ‰§è¡Œ  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0 