# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ£€æŸ¥æ¸…å•

**æ–‡æ¡£ç¼–å·**: OPS-008  
**åˆ›å»ºæ—¶é—´**: 2025-06-26  
**æ›´æ–°æ—¶é—´**: 2025-06-26  
**è´Ÿè´£äºº**: ä¸»æ§Agent  

## ğŸ¯ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### ğŸ“‹ åŸºç¡€ç¯å¢ƒæ£€æŸ¥
- [ ] Dockerå’ŒDocker Composeå·²å®‰è£…
- [ ] æœåŠ¡å™¨èµ„æºå……è¶³ï¼ˆCPU â‰¥ 2æ ¸ï¼Œå†…å­˜ â‰¥ 4GBï¼Œç£ç›˜ â‰¥ 20GBï¼‰
- [ ] ç½‘ç»œç«¯å£å·²å¼€æ”¾ï¼ˆ80, 443, 3000-3003, 5432, 6379ï¼‰
- [ ] SSLè¯ä¹¦å·²é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] åŸŸåDNSå·²è§£æ
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®

### ğŸ”§ é…ç½®æ–‡ä»¶æ£€æŸ¥
- [ ] `docker-compose.yml` ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] `deploy/nginx/nginx.production.conf` å·²æ›´æ–°
- [ ] æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬å·²å‡†å¤‡
- [ ] ç¯å¢ƒå˜é‡æ–‡ä»¶å·²åˆ›å»ºï¼ˆ.envï¼‰
- [ ] å¤‡ä»½ç­–ç•¥å·²é…ç½®

### ğŸ” å®‰å…¨é…ç½®æ£€æŸ¥
- [ ] JWTå¯†é’¥å·²æ›´æ–°
- [ ] æ•°æ®åº“å¯†ç å·²æ›´æ”¹
- [ ] Rediså¯†ç å·²è®¾ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] SMTPå‡­è¯å·²é…ç½®
- [ ] APIå¯†é’¥å·²è®¾ç½®
- [ ] æ•æ„Ÿä¿¡æ¯æœªç¡¬ç¼–ç 

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /opt/edm
cd /opt/edm

# å…‹éš†é¡¹ç›®
git clone https://github.com/tony-amt/EDM.git .

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p data/{postgres,redis,backups,uploads}
mkdir -p logs

# è®¾ç½®æƒé™
chmod +x scripts/*.sh
```

### 2. é…ç½®ç¯å¢ƒå˜é‡
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp config/frontend.env.production .env.frontend
cp config/backend.env.production .env.backend

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano .env.frontend
nano .env.backend
```

### 3. å¯åŠ¨æœåŠ¡
```bash
# ä½¿ç”¨ç”Ÿäº§é…ç½®å¯åŠ¨
docker-compose -f docker-compose.yml up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps
```

### 4. åˆå§‹åŒ–æ•°æ®åº“
```bash
# ç­‰å¾…æ•°æ®åº“å¯åŠ¨
sleep 30

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec edm-postgres pg_isready -U postgres

# åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·ï¼ˆå¦‚æœéœ€è¦ï¼‰
docker exec edm-backend npm run create-admin
```

## ğŸ” éƒ¨ç½²åéªŒè¯

### åŸºç¡€åŠŸèƒ½éªŒè¯
```bash
# 1. å¥åº·æ£€æŸ¥
curl -f http://localhost:3000/health

# 2. å‰ç«¯è®¿é—®
curl -f http://localhost:3001

# 3. APIæµ‹è¯•
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123456"}'

# 4. æ•°æ®åº“è¿æ¥
docker exec edm-postgres psql -U postgres -d amt_mail_system -c "SELECT COUNT(*) FROM users;"

# 5. Redisè¿æ¥
docker exec edm-redis redis-cli ping
```

### è°ƒåº¦æœåŠ¡éªŒè¯
```bash
# è¿è¡Œè°ƒåº¦å™¨çŠ¶æ€æ£€æŸ¥
./scripts/check-scheduler-status.sh

# æ£€æŸ¥å®šæ—¶å™¨æ—¥å¿—
docker logs edm-backend | grep -E "(å®šæ—¶å™¨|timer|è°ƒåº¦å™¨)"

# éªŒè¯è°ƒåº¦å™¨API
curl http://localhost:3000/api/scheduler/health
```

### å‰ç«¯è·¯ç”±éªŒè¯
- [ ] ç›´æ¥è®¿é—®é¡µé¢URLä¸å‡ºç°404
- [ ] åˆ·æ–°é¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] å‰ç«¯è·¯ç”±è·³è½¬æ­£å¸¸
- [ ] é™æ€èµ„æºåŠ è½½æ­£å¸¸

## ğŸ”„ ç”Ÿäº§ç¯å¢ƒç›‘æ§è®¾ç½®

### 1. ç³»ç»Ÿç›‘æ§è„šæœ¬
```bash
# æ·»åŠ åˆ°ç³»ç»Ÿcron
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹ä»»åŠ¡ï¼š
# æ¯10åˆ†é’Ÿæ£€æŸ¥æœåŠ¡çŠ¶æ€
*/10 * * * * /opt/edm/scripts/check-scheduler-status.sh >> /var/log/edm-monitor.log 2>&1

# æ¯æ—¥å‡Œæ™¨2ç‚¹é‡ç½®é¢åº¦
0 2 * * * /opt/edm/scripts/reset-daily-quotas.sh

# æ¯æ—¥å‡Œæ™¨4ç‚¹å¤‡ä»½æ•°æ®åº“
0 4 * * * /opt/edm/scripts/backup-database.sh
```

### 2. æ—¥å¿—è½®è½¬é…ç½®
```bash
# åˆ›å»ºæ—¥å¿—è½®è½¬é…ç½®
sudo tee /etc/logrotate.d/edm << EOF
/var/log/edm-*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
}
EOF
```

### 3. ç›‘æ§å‘Šè­¦
```bash
# åˆ›å»ºå‘Šè­¦è„šæœ¬
cat > /opt/edm/scripts/health-alert.sh << 'EOF'
#!/bin/bash
HEALTH_URL="http://localhost:3000/health"
RESPONSE=$(curl -s -w "%{http_code}" $HEALTH_URL -o /dev/null)

if [ "$RESPONSE" != "200" ]; then
    echo "EDMç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥: HTTP $RESPONSE" | \
    mail -s "EDMç³»ç»Ÿå‘Šè­¦" admin@yourdomain.com
fi
EOF

chmod +x /opt/edm/scripts/health-alert.sh

# æ·»åŠ åˆ°cron
echo "*/5 * * * * /opt/edm/scripts/health-alert.sh" | crontab -
```

## ğŸ› ï¸ æ•…éšœæ’æŸ¥æŒ‡å—

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. å®¹å™¨å¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥å®¹å™¨æ—¥å¿—
docker-compose logs [service_name]

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep [port]

# é‡å¯æœåŠ¡
docker-compose restart [service_name]
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
docker exec edm-postgres pg_isready -U postgres

# æ£€æŸ¥è¿æ¥é…ç½®
docker exec edm-backend cat /app/config/config.js

# é‡ç½®æ•°æ®åº“å¯†ç 
docker exec edm-postgres psql -U postgres -c "ALTER USER postgres PASSWORD 'new_password';"
```

#### 3. å‰ç«¯404é”™è¯¯
```bash
# æ£€æŸ¥nginxé…ç½®
docker exec edm-nginx nginx -t

# é‡è½½nginxé…ç½®
docker exec edm-nginx nginx -s reload

# æ£€æŸ¥å‰ç«¯æ„å»º
docker exec edm-frontend ls -la /usr/share/nginx/html/
```

#### 4. è°ƒåº¦å™¨åœæ­¢è¿è¡Œ
```bash
# æ£€æŸ¥è°ƒåº¦å™¨çŠ¶æ€
curl http://localhost:3000/api/scheduler/health

# é‡å¯åç«¯æœåŠ¡
docker-compose restart backend

# æ£€æŸ¥è°ƒåº¦å™¨æ—¥å¿—
docker logs edm-backend | grep scheduler
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–
- å®šæœŸæ‰§è¡ŒVACUUMå’ŒANALYZE
- ç›‘æ§æ…¢æŸ¥è¯¢æ—¥å¿—
- é€‚å½“è°ƒæ•´è¿æ¥æ± å¤§å°
- åˆ›å»ºå¿…è¦çš„ç´¢å¼•

### 2. Redisä¼˜åŒ–
- è®¾ç½®åˆé€‚çš„å†…å­˜é™åˆ¶
- é…ç½®æŒä¹…åŒ–ç­–ç•¥
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
- å®šæœŸæ¸…ç†è¿‡æœŸé”®

### 3. åº”ç”¨ä¼˜åŒ–
- å¯ç”¨Gzipå‹ç¼©
- é…ç½®é™æ€èµ„æºç¼“å­˜
- ä½¿ç”¨CDNåŠ é€Ÿï¼ˆå¦‚éœ€è¦ï¼‰
- ç›‘æ§APIå“åº”æ—¶é—´

### 4. ç³»ç»Ÿä¼˜åŒ–
- é…ç½®åˆé€‚çš„ulimit
- è°ƒæ•´å†…æ ¸å‚æ•°
- ç›‘æ§ç£ç›˜ç©ºé—´
- å®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶

## ğŸ“ ç»´æŠ¤è®¡åˆ’

### æ—¥å¸¸ç»´æŠ¤ï¼ˆæ¯æ—¥ï¼‰
- [ ] æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€
- [ ] æŸ¥çœ‹é”™è¯¯æ—¥å¿—
- [ ] ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
- [ ] éªŒè¯å¤‡ä»½å®Œæˆ

### å‘¨åº¦ç»´æŠ¤ï¼ˆæ¯å‘¨ï¼‰
- [ ] åˆ†ææ€§èƒ½æŒ‡æ ‡
- [ ] æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- [ ] æ£€æŸ¥ç£ç›˜ç©ºé—´
- [ ] æ›´æ–°å®‰å…¨è¡¥ä¸

### æœˆåº¦ç»´æŠ¤ï¼ˆæ¯æœˆï¼‰
- [ ] æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–
- [ ] æ—¥å¿—æ–‡ä»¶å½’æ¡£
- [ ] å¤‡ä»½ç­–ç•¥éªŒè¯
- [ ] å®¹é‡è§„åˆ’è¯„ä¼°

## ğŸ”’ å®‰å…¨æ£€æŸ¥æ¸…å•

### åº”ç”¨å®‰å…¨
- [ ] APIæ¥å£å·²å®æ–½è®¤è¯
- [ ] è¾“å…¥éªŒè¯å·²å®Œå–„
- [ ] SQLæ³¨å…¥é˜²æŠ¤å·²å¯ç”¨
- [ ] XSSé˜²æŠ¤å·²é…ç½®
- [ ] CSRFä¿æŠ¤å·²å®æ–½

### ç½‘ç»œå®‰å…¨
- [ ] HTTPSå·²å¯ç”¨
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [ ] ä¸å¿…è¦ç«¯å£å·²å…³é—­
- [ ] è®¿é—®æ—¥å¿—å·²å¯ç”¨
- [ ] å¼‚å¸¸è®¿é—®ç›‘æ§å·²é…ç½®

### æ•°æ®å®‰å…¨
- [ ] æ•°æ®åº“è®¿é—®å·²é™åˆ¶
- [ ] æ•æ„Ÿæ•°æ®å·²åŠ å¯†
- [ ] å¤‡ä»½æ•°æ®å·²åŠ å¯†
- [ ] è®¿é—®æƒé™å·²æœ€å°åŒ–
- [ ] å®¡è®¡æ—¥å¿—å·²å¯ç”¨

## ğŸ“ åº”æ€¥è”ç³»æ–¹å¼

| è§’è‰² | è”ç³»æ–¹å¼ | èŒè´£ |
|------|----------|------|
| ç³»ç»Ÿç®¡ç†å‘˜ | admin@yourdomain.com | ç³»ç»Ÿç»´æŠ¤å’Œæ•…éšœå¤„ç† |
| å¼€å‘è´Ÿè´£äºº | dev@yourdomain.com | ä»£ç é—®é¢˜å’ŒåŠŸèƒ½æ•…éšœ |
| è¿ç»´è´Ÿè´£äºº | ops@yourdomain.com | åŸºç¡€è®¾æ–½å’Œéƒ¨ç½²é—®é¢˜ |

---

**æ³¨æ„**: æ­¤æ£€æŸ¥æ¸…å•åº”æ ¹æ®å®é™…éƒ¨ç½²ç¯å¢ƒè¿›è¡Œè°ƒæ•´ã€‚å»ºè®®åœ¨ç”Ÿäº§éƒ¨ç½²å‰åœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´éªŒè¯æ‰€æœ‰æ­¥éª¤ã€‚ 