# 生产环境部署检查清单

**文档编号**: OPS-008  
**创建时间**: 2025-06-26  
**更新时间**: 2025-06-26  
**负责人**: 主控Agent  

## 🎯 部署前检查清单

### 📋 基础环境检查
- [ ] Docker和Docker Compose已安装
- [ ] 服务器资源充足（CPU ≥ 2核，内存 ≥ 4GB，磁盘 ≥ 20GB）
- [ ] 网络端口已开放（80, 443, 3000-3003, 5432, 6379）
- [ ] SSL证书已配置（生产环境）
- [ ] 域名DNS已解析
- [ ] 防火墙规则已配置

### 🔧 配置文件检查
- [ ] `docker-compose.yml` 环境变量已配置
- [ ] `deploy/nginx/nginx.production.conf` 已更新
- [ ] 数据库初始化脚本已准备
- [ ] 环境变量文件已创建（.env）
- [ ] 备份策略已配置

### 🔐 安全配置检查
- [ ] JWT密钥已更新
- [ ] 数据库密码已更改
- [ ] Redis密码已设置（如需要）
- [ ] SMTP凭证已配置
- [ ] API密钥已设置
- [ ] 敏感信息未硬编码

## 🚀 部署步骤

### 1. 环境准备
```bash
# 创建项目目录
mkdir -p /opt/edm
cd /opt/edm

# 克隆项目
git clone https://github.com/tony-amt/EDM.git .

# 创建数据目录
mkdir -p data/{postgres,redis,backups,uploads}
mkdir -p logs

# 设置权限
chmod +x scripts/*.sh
```

### 2. 配置环境变量
```bash
# 复制环境变量模板
cp config/frontend.env.production .env.frontend
cp config/backend.env.production .env.backend

# 编辑配置文件
nano .env.frontend
nano .env.backend
```

### 3. 启动服务
```bash
# 使用生产配置启动
docker-compose -f docker-compose.yml up -d

# 检查服务状态
docker-compose ps
```

### 4. 初始化数据库
```bash
# 等待数据库启动
sleep 30

# 检查数据库连接
docker exec edm-postgres pg_isready -U postgres

# 创建管理员账户（如果需要）
docker exec edm-backend npm run create-admin
```

## 🔍 部署后验证

### 基础功能验证
```bash
# 1. 健康检查
curl -f http://localhost:3000/health

# 2. 前端访问
curl -f http://localhost:3001

# 3. API测试
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123456"}'

# 4. 数据库连接
docker exec edm-postgres psql -U postgres -d amt_mail_system -c "SELECT COUNT(*) FROM users;"

# 5. Redis连接
docker exec edm-redis redis-cli ping
```

### 调度服务验证
```bash
# 运行调度器状态检查
./scripts/check-scheduler-status.sh

# 检查定时器日志
docker logs edm-backend | grep -E "(定时器|timer|调度器)"

# 验证调度器API
curl http://localhost:3000/api/scheduler/health
```

### 前端路由验证
- [ ] 直接访问页面URL不出现404
- [ ] 刷新页面正常显示
- [ ] 前端路由跳转正常
- [ ] 静态资源加载正常

## 🔄 生产环境监控设置

### 1. 系统监控脚本
```bash
# 添加到系统cron
sudo crontab -e

# 添加以下任务：
# 每10分钟检查服务状态
*/10 * * * * /opt/edm/scripts/check-scheduler-status.sh >> /var/log/edm-monitor.log 2>&1

# 每日凌晨2点重置额度
0 2 * * * /opt/edm/scripts/reset-daily-quotas.sh

# 每日凌晨4点备份数据库
0 4 * * * /opt/edm/scripts/backup-database.sh
```

### 2. 日志轮转配置
```bash
# 创建日志轮转配置
sudo tee /etc/logrotate.d/edm << EOF
/var/log/edm-*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
}
EOF
```

### 3. 监控告警
```bash
# 创建告警脚本
cat > /opt/edm/scripts/health-alert.sh << 'EOF'
#!/bin/bash
HEALTH_URL="http://localhost:3000/health"
RESPONSE=$(curl -s -w "%{http_code}" $HEALTH_URL -o /dev/null)

if [ "$RESPONSE" != "200" ]; then
    echo "EDM系统健康检查失败: HTTP $RESPONSE" | \
    mail -s "EDM系统告警" admin@yourdomain.com
fi
EOF

chmod +x /opt/edm/scripts/health-alert.sh

# 添加到cron
echo "*/5 * * * * /opt/edm/scripts/health-alert.sh" | crontab -
```

## 🛠️ 故障排查指南

### 常见问题及解决方案

#### 1. 容器启动失败
```bash
# 检查容器日志
docker-compose logs [service_name]

# 检查端口占用
netstat -tulpn | grep [port]

# 重启服务
docker-compose restart [service_name]
```

#### 2. 数据库连接失败
```bash
# 检查数据库状态
docker exec edm-postgres pg_isready -U postgres

# 检查连接配置
docker exec edm-backend cat /app/config/config.js

# 重置数据库密码
docker exec edm-postgres psql -U postgres -c "ALTER USER postgres PASSWORD 'new_password';"
```

#### 3. 前端404错误
```bash
# 检查nginx配置
docker exec edm-nginx nginx -t

# 重载nginx配置
docker exec edm-nginx nginx -s reload

# 检查前端构建
docker exec edm-frontend ls -la /usr/share/nginx/html/
```

#### 4. 调度器停止运行
```bash
# 检查调度器状态
curl http://localhost:3000/api/scheduler/health

# 重启后端服务
docker-compose restart backend

# 检查调度器日志
docker logs edm-backend | grep scheduler
```

## 📊 性能优化建议

### 1. 数据库优化
- 定期执行VACUUM和ANALYZE
- 监控慢查询日志
- 适当调整连接池大小
- 创建必要的索引

### 2. Redis优化
- 设置合适的内存限制
- 配置持久化策略
- 监控内存使用情况
- 定期清理过期键

### 3. 应用优化
- 启用Gzip压缩
- 配置静态资源缓存
- 使用CDN加速（如需要）
- 监控API响应时间

### 4. 系统优化
- 配置合适的ulimit
- 调整内核参数
- 监控磁盘空间
- 定期清理日志文件

## 📝 维护计划

### 日常维护（每日）
- [ ] 检查服务运行状态
- [ ] 查看错误日志
- [ ] 监控资源使用情况
- [ ] 验证备份完成

### 周度维护（每周）
- [ ] 分析性能指标
- [ ] 清理临时文件
- [ ] 检查磁盘空间
- [ ] 更新安全补丁

### 月度维护（每月）
- [ ] 数据库性能优化
- [ ] 日志文件归档
- [ ] 备份策略验证
- [ ] 容量规划评估

## 🔒 安全检查清单

### 应用安全
- [ ] API接口已实施认证
- [ ] 输入验证已完善
- [ ] SQL注入防护已启用
- [ ] XSS防护已配置
- [ ] CSRF保护已实施

### 网络安全
- [ ] HTTPS已启用
- [ ] 防火墙规则已配置
- [ ] 不必要端口已关闭
- [ ] 访问日志已启用
- [ ] 异常访问监控已配置

### 数据安全
- [ ] 数据库访问已限制
- [ ] 敏感数据已加密
- [ ] 备份数据已加密
- [ ] 访问权限已最小化
- [ ] 审计日志已启用

## 📞 应急联系方式

| 角色 | 联系方式 | 职责 |
|------|----------|------|
| 系统管理员 | admin@yourdomain.com | 系统维护和故障处理 |
| 开发负责人 | dev@yourdomain.com | 代码问题和功能故障 |
| 运维负责人 | ops@yourdomain.com | 基础设施和部署问题 |

---

**注意**: 此检查清单应根据实际部署环境进行调整。建议在生产部署前在测试环境完整验证所有步骤。 