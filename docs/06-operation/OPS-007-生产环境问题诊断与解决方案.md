# 生产环境问题诊断与解决方案

**文档编号**: OPS-007  
**创建时间**: 2025-06-26  
**更新时间**: 2025-06-26  
**负责人**: 主控Agent  

## 🎯 问题概述

### 问题1：前端路由刷新404问题
- **现象**: 用户可以通过点击正常访问页面，但刷新页面时出现404错误
- **影响**: 用户体验严重受损，无法直接访问特定页面URL
- **紧急程度**: 高

### 问题2：定时调度服务状态检查
- **现象**: 需要确认生产环境的定时调度服务是否正常运行
- **影响**: 邮件群发、额度重置、服务管理等核心功能可能受影响
- **紧急程度**: 高

## 🔍 问题分析

### 问题1：前端路由404分析

#### 根本原因
React单页应用使用前端路由（React Router），当用户直接访问或刷新特定路由时，nginx尝试查找对应的静态文件，但这些路由只存在于前端，需要将所有路由请求重定向到`index.html`。

#### 技术细节
- **开发环境**: React开发服务器内置路由支持，无此问题
- **生产环境**: nginx需要配置`try_files`指令支持SPA路由
- **当前状态**: 生产nginx配置缺少React路由支持

### 问题2：定时调度服务分析

#### 当前运行状态
根据容器日志分析，调度器已正常启动：
```
✅ 队列调度器启动完成
✅ 启动了 2 个发信服务的轮询定时器
✅ scheduled任务检查定时器启动，间隔: 30秒
```

#### 核心调度服务
1. **邮件群发任务调度器**: 每30秒检查scheduled状态的任务
2. **发信服务轮询器**: 每个服务独立的定时器（53-55秒间隔）
3. **额度重置服务**: 数据库存储过程支持
4. **Webhook接收服务**: 独立容器运行
5. **服务冻结检查**: 自动检测和恢复机制

## 🛠️ 解决方案

### 问题1：修复前端路由404

#### 方案A：修复生产nginx配置（推荐）
```nginx
# 在 deploy/nginx/nginx.production.conf 中添加
location / {
    proxy_pass http://frontend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # React路由支持 - 解决刷新404问题
    try_files $uri $uri/ @fallback;
}

# React路由回退处理
location @fallback {
    proxy_pass http://frontend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

#### 方案B：前端容器nginx配置
如果使用生产Dockerfile.prod，确保nginx.conf包含：
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

### 问题2：定时调度服务保障

#### 服务监控脚本
创建定时调度服务监控脚本：

```bash
#!/bin/bash
# scripts/check-scheduler-status.sh

echo "=== EDM调度服务状态检查 ==="

# 1. 检查容器运行状态
echo "1. 容器状态检查:"
docker ps | grep edm

# 2. 检查调度器日志
echo -e "\n2. 调度器启动状态:"
docker logs edm-backend-debug 2>&1 | grep -E "(调度器|scheduler|队列|queue)" | tail -10

# 3. 检查定时器运行状态
echo -e "\n3. 定时器状态:"
docker logs edm-backend-debug 2>&1 | grep -E "(定时器|timer|轮询)" | tail -5

# 4. 检查数据库连接
echo -e "\n4. 数据库连接状态:"
docker exec edm-postgres-debug pg_isready -U postgres

# 5. 检查Redis连接
echo -e "\n5. Redis连接状态:"
docker exec edm-redis-debug redis-cli ping

echo -e "\n=== 检查完成 ==="
```

#### 自动重启机制
在docker-compose.yml中确保重启策略：
```yaml
backend:
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s
```

#### 额度重置定时任务
创建系统cron任务：
```bash
# 每日凌晨2点重置服务额度
0 2 * * * docker exec edm-postgres-debug psql -U postgres -d amt_mail_system -c "SELECT reset_service_quotas();"

# 每日凌晨3点重置用户额度（如果需要）
0 3 * * * docker exec edm-postgres-debug psql -U postgres -d amt_mail_system -c "UPDATE users SET remaining_quota = daily_quota WHERE daily_quota > 0;"
```

## 🚀 部署步骤

### 立即修复步骤

1. **修复nginx配置**
```bash
# 已完成配置文件修改
# 重启nginx或重新部署
docker-compose restart nginx  # 如果有nginx容器
# 或重新部署整个应用
```

2. **验证调度服务**
```bash
# 运行状态检查脚本
chmod +x scripts/check-scheduler-status.sh
./scripts/check-scheduler-status.sh
```

3. **设置监控**
```bash
# 添加到系统cron
sudo crontab -e
# 添加以下行：
# */10 * * * * /path/to/EDM/scripts/check-scheduler-status.sh >> /var/log/edm-scheduler.log 2>&1
```

### 长期优化措施

1. **实施健康检查API**
```javascript
// 在后端添加调度器健康检查端点
app.get('/api/scheduler/health', (req, res) => {
  const QueueScheduler = require('./services/infrastructure/QueueScheduler');
  const scheduler = QueueScheduler.getInstance();
  
  res.json({
    status: scheduler.isRunning ? 'running' : 'stopped',
    activeTimers: scheduler.getActiveTimersCount(),
    lastActivity: scheduler.getLastActivity(),
    services: scheduler.getServiceStatus()
  });
});
```

2. **实施告警机制**
```bash
# 调度器停止告警脚本
#!/bin/bash
HEALTH_URL="http://localhost:3000/api/scheduler/health"
RESPONSE=$(curl -s $HEALTH_URL)
STATUS=$(echo $RESPONSE | jq -r '.status')

if [ "$STATUS" != "running" ]; then
    # 发送告警邮件或消息
    echo "EDM调度器已停止运行！" | mail -s "EDM系统告警" admin@yourdomain.com
fi
```

## 📊 验证清单

### 前端路由修复验证
- [ ] 直接访问页面URL无404错误
- [ ] 刷新任意页面正常显示
- [ ] 前端路由跳转正常工作
- [ ] 静态资源加载正常

### 调度服务验证
- [ ] 容器状态健康
- [ ] 调度器日志显示正常启动
- [ ] 定时器按预期间隔运行
- [ ] 数据库和Redis连接正常
- [ ] 测试任务能正常调度
- [ ] 额度重置功能正常
- [ ] Webhook接收正常

## 🔄 监控和维护

### 日常监控指标
1. **调度器运行状态**: 每10分钟检查
2. **任务处理队列**: 监控积压情况
3. **服务额度使用**: 监控接近限制的服务
4. **错误日志**: 监控异常和错误

### 定期维护任务
1. **每日**: 检查调度器日志和状态
2. **每周**: 清理过期日志和临时文件
3. **每月**: 分析性能指标和优化建议

## 📝 变更记录

| 日期 | 变更内容 | 负责人 |
|------|----------|--------|
| 2025-06-26 | 创建文档，修复nginx配置 | 主控Agent |
| 2025-06-26 | 添加调度服务监控方案 | 主控Agent |

---

**注意**: 此文档应根据实际部署环境和监控需求进行调整。建议在生产环境实施前先在测试环境验证所有解决方案。 