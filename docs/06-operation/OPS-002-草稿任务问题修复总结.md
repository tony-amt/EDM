# OPS-002-è‰ç¨¿ä»»åŠ¡é—®é¢˜ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¤ä¸ªå…³äºè‰ç¨¿ä»»åŠ¡çš„é—®é¢˜ï¼š
1. è‰ç¨¿ä¸­çš„ä»»åŠ¡ï¼Œç‚¹å‡»å¯åŠ¨å‘é€ï¼ŒæŠ¥é”™
2. è‰ç¨¿ä¸­çš„ä»»åŠ¡ï¼Œåº”è¯¥æ²¡æœ‰è®¡åˆ’æ—¶é—´

## é—®é¢˜åˆ†æ

é€šè¿‡ç«¯åˆ°ç«¯æµ‹è¯•å‘ç°äº†ä»¥ä¸‹æ ¹æœ¬åŸå› ï¼š

### 1. æ•°æ®æ¨¡å‹é—®é¢˜
- `Task.schedule_time` å­—æ®µè®¾ç½®ä¸º `allowNull: false`ï¼Œå¯¼è‡´è‰ç¨¿ä»»åŠ¡æ— æ³•åˆ›å»º
- ä»»åŠ¡åˆ›å»ºéªŒè¯é€»è¾‘è¦æ±‚ `schedule_time` ä¸ºå¿…å¡«å­—æ®µ

### 2. è·¯ç”±éªŒè¯é—®é¢˜
- ä»»åŠ¡åˆ›å»ºè·¯ç”±ä¸­ `schedule_time` éªŒè¯è§„åˆ™ç¼ºå°‘ `.optional()`
- å¯¼è‡´å‰ç«¯æ— æ³•åˆ›å»ºæ²¡æœ‰è®¡åˆ’æ—¶é—´çš„è‰ç¨¿ä»»åŠ¡

### 3. æ ‡ç­¾æŸ¥è¯¢é—®é¢˜
- `calculateRecipientCount` å’Œ `getTaskContacts` æ–¹æ³•ä¸­ä½¿ç”¨äº†é”™è¯¯çš„æ ‡ç­¾æŸ¥è¯¢æ¡ä»¶
- ä½¿ç”¨ `{ id: { [Op.in]: include_tags } }` è€Œä¸æ˜¯ `{ name: { [Op.in]: include_tags } }`

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ•°æ®æ¨¡å‹ä¿®å¤
**æ–‡ä»¶**: `src/backend/src/models/task.model.js`
```javascript
// ä¿®æ”¹å‰
schedule_time: {
  type: DataTypes.DATE,
  allowNull: false,
},

// ä¿®æ”¹å
schedule_time: {
  type: DataTypes.DATE,
  allowNull: true, // è‰ç¨¿ä»»åŠ¡å¯ä»¥ä¸ºç©º
},
```

### 2. è·¯ç”±éªŒè¯ä¿®å¤
**æ–‡ä»¶**: `src/backend/src/routes/task.routes.js`
```javascript
// ä¿®æ”¹å‰
body('schedule_time')
  .isISO8601()
  .withMessage('Valid schedule time is required'),

// ä¿®æ”¹å
body('schedule_time')
  .optional() // æ·»åŠ å¯é€‰éªŒè¯
  .isISO8601()
  .withMessage('Valid schedule time is required'),
```

### 3. ä»»åŠ¡åˆ›å»ºé€»è¾‘ä¿®å¤
**æ–‡ä»¶**: `src/backend/src/services/core/task.service.js`

#### 3.1 éªŒè¯é€»è¾‘ä¿®å¤
```javascript
// ä¿®æ”¹å‰
if (!name || !schedule_time || !recipient_rule || !template_ids || !Array.isArray(template_ids) || template_ids.length === 0 || !sender_id) {
  throw new AppError('Missing required fields for task creation', 400);
}

// ä¿®æ”¹å
if (!name || !recipient_rule || !template_ids || !Array.isArray(template_ids) || template_ids.length === 0 || !sender_id) {
  throw new AppError('Missing required fields for task creation', 400);
}
```

#### 3.2 ä»»åŠ¡åˆ›å»ºæ•°æ®å¤„ç†
```javascript
// ä¿®æ”¹å‰
const task = await Task.create({
  name,
  description,
  schedule_time: new Date(schedule_time),
  scheduled_at: new Date(schedule_time),
  // ...å…¶ä»–å­—æ®µ
}, { transaction });

// ä¿®æ”¹å
const taskCreateData = {
  name,
  description,
  // ...å…¶ä»–å­—æ®µ
};

// åªæœ‰æä¾›äº†schedule_timeæ‰è®¾ç½®æ—¶é—´å­—æ®µ
if (schedule_time) {
  taskCreateData.schedule_time = new Date(schedule_time);
  taskCreateData.scheduled_at = new Date(schedule_time);
}

const task = await Task.create(taskCreateData, { transaction });
```

### 4. æ ‡ç­¾æŸ¥è¯¢ä¿®å¤
**æ–‡ä»¶**: `src/backend/src/services/core/task.service.js`

åœ¨ `calculateRecipientCount` å’Œ `getTaskContacts` æ–¹æ³•ä¸­ï¼š
```javascript
// ä¿®æ”¹å‰
where: { id: { [Op.in]: include_tags } }

// ä¿®æ”¹å
where: { name: { [Op.in]: include_tags } }
```

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
- âœ… è‰ç¨¿ä»»åŠ¡åˆ›å»ºæµ‹è¯•
- âœ… ä»»åŠ¡æ›´æ–°æµ‹è¯•
- âœ… çŠ¶æ€è½¬æ¢æµ‹è¯•

### 2. é›†æˆæµ‹è¯•
- âœ… å‰ç«¯-åç«¯é›†æˆæµ‹è¯•
- âœ… å®Œæ•´ç”¨æˆ·æ“ä½œæµç¨‹æµ‹è¯•

### 3. ç«¯åˆ°ç«¯æµ‹è¯•ç»“æœ
```
ğŸ¯ å‰ç«¯é›†æˆæµ‹è¯•ï¼šå®Œæ•´ç”¨æˆ·æ“ä½œæµç¨‹

âœ… è‰ç¨¿ä»»åŠ¡åˆ›å»º - æ— è®¡åˆ’æ—¶é—´ï¼ŒçŠ¶æ€ä¸ºdraft
âœ… è‰ç¨¿ä»»åŠ¡ç¼–è¾‘ - å¯ä»¥æ·»åŠ è®¡åˆ’æ—¶é—´
âœ… å¯åŠ¨å‘é€æµç¨‹ - draft â†’ scheduled â†’ sending
âœ… å­ä»»åŠ¡ç”Ÿæˆ - è‡ªåŠ¨åˆ›å»ºå­ä»»åŠ¡
âœ… çŠ¶æ€ç®¡ç† - æš‚åœã€æ¢å¤ç­‰åŠŸèƒ½æ­£å¸¸
âœ… å‰åç«¯é›†æˆ - APIå“åº”æ ¼å¼æ­£ç¡®
```

## åŠŸèƒ½éªŒè¯

### 1. è‰ç¨¿ä»»åŠ¡åˆ›å»º
- âœ… å¯ä»¥åˆ›å»ºæ²¡æœ‰è®¡åˆ’æ—¶é—´çš„è‰ç¨¿ä»»åŠ¡
- âœ… ä»»åŠ¡çŠ¶æ€æ­£ç¡®è®¾ç½®ä¸º `draft`
- âœ… `schedule_time` å’Œ `scheduled_at` å­—æ®µä¸º `null`
- âœ… ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆå­ä»»åŠ¡

### 2. è‰ç¨¿ä»»åŠ¡ç¼–è¾‘
- âœ… å¯ä»¥ä¸ºè‰ç¨¿ä»»åŠ¡æ·»åŠ è®¡åˆ’æ—¶é—´
- âœ… å¯ä»¥ä¿®æ”¹ä»»åŠ¡çš„å…¶ä»–å±æ€§
- âœ… çŠ¶æ€ä¿æŒä¸º `draft` ç›´åˆ°æ‰‹åŠ¨è½¬æ¢

### 3. å¯åŠ¨å‘é€æµç¨‹
- âœ… å¿…é¡»å…ˆè®¾ç½®è®¡åˆ’æ—¶é—´æ‰èƒ½è½¬æ¢ä¸º `scheduled`
- âœ… è½¬æ¢ä¸º `scheduled` æ—¶è‡ªåŠ¨ç”Ÿæˆå­ä»»åŠ¡
- âœ… å¯ä»¥ä» `scheduled` è½¬æ¢ä¸º `sending`
- âœ… è®°å½•æ­£ç¡®çš„æ—¶é—´æˆ³

### 4. çŠ¶æ€ç®¡ç†
- âœ… æ”¯æŒå®Œæ•´çš„çŠ¶æ€è½¬æ¢æµç¨‹
- âœ… æš‚åœå’Œæ¢å¤åŠŸèƒ½æ­£å¸¸
- âœ… å…³é—­çŠ¶æ€çš„ä¸å¯å˜æ€§

## å½±å“è¯„ä¼°

### 1. æ•°æ®åº“å½±å“
- **ä½é£é™©**: åªä¿®æ”¹äº†å­—æ®µçš„ `allowNull` å±æ€§
- **å‘åå…¼å®¹**: ç°æœ‰æ•°æ®ä¸å—å½±å“

### 2. APIå½±å“
- **ä½é£é™©**: åªæ”¾å®½äº†éªŒè¯è§„åˆ™ï¼Œæ²¡æœ‰ç ´åæ€§å˜æ›´
- **å‘åå…¼å®¹**: ç°æœ‰APIè°ƒç”¨ä»ç„¶æœ‰æ•ˆ

### 3. å‰ç«¯å½±å“
- **æ­£é¢å½±å“**: è§£å†³äº†è‰ç¨¿ä»»åŠ¡åˆ›å»ºå’Œç¼–è¾‘çš„é—®é¢˜
- **ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·ç°åœ¨å¯ä»¥æ­£å¸¸åˆ›å»ºå’Œç®¡ç†è‰ç¨¿ä»»åŠ¡

## éƒ¨ç½²è¯´æ˜

### 1. æ•°æ®åº“è¿ç§»
æ— éœ€ç‰¹æ®Šçš„æ•°æ®åº“è¿ç§»ï¼Œæ¨¡å‹å˜æ›´ä¼šåœ¨åº”ç”¨é‡å¯æ—¶è‡ªåŠ¨åº”ç”¨ã€‚

### 2. åº”ç”¨é‡å¯
éœ€è¦é‡å¯åç«¯åº”ç”¨ä»¥åº”ç”¨æ¨¡å‹å˜æ›´ï¼š
```bash
docker restart edm-backend
```

### 3. éªŒè¯æ­¥éª¤
1. åˆ›å»ºè‰ç¨¿ä»»åŠ¡ï¼ˆä¸è®¾ç½®è®¡åˆ’æ—¶é—´ï¼‰
2. ç¼–è¾‘è‰ç¨¿ä»»åŠ¡æ·»åŠ è®¡åˆ’æ—¶é—´
3. å¯åŠ¨å‘é€æµç¨‹
4. éªŒè¯çŠ¶æ€è½¬æ¢å’Œå­ä»»åŠ¡ç”Ÿæˆ

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†è‰ç¨¿ä»»åŠ¡çš„ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. **è‰ç¨¿ä»»åŠ¡åˆ›å»º**: ç°åœ¨å¯ä»¥åˆ›å»ºæ²¡æœ‰è®¡åˆ’æ—¶é—´çš„è‰ç¨¿ä»»åŠ¡
2. **å¯åŠ¨å‘é€**: è‰ç¨¿ä»»åŠ¡å¯ä»¥æ­£å¸¸ç¼–è¾‘å’Œå¯åŠ¨å‘é€

ä¿®å¤è¿‡ç¨‹ä¸­è¿˜å‘ç°å¹¶è§£å†³äº†æ ‡ç­¾æŸ¥è¯¢çš„é—®é¢˜ï¼Œæé«˜äº†ç³»ç»Ÿçš„æ•´ä½“ç¨³å®šæ€§ã€‚æ‰€æœ‰ä¿®æ”¹éƒ½ç»è¿‡äº†å…¨é¢çš„æµ‹è¯•éªŒè¯ï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸ä¸”ä¸å½±å“ç°æœ‰åŠŸèƒ½ã€‚

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-06-12  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**éƒ¨ç½²çŠ¶æ€**: âœ… å·²éƒ¨ç½²  
**å½±å“è¯„ä¼°**: ğŸŸ¢ ä½é£é™©ï¼Œæ­£é¢å½±å“ 