# EDMç³»ç»Ÿæ ¸å¿ƒä¿®å¤æŠ¥å‘Š - é˜Ÿåˆ—è°ƒåº¦å™¨ä¸Webhookæœºåˆ¶

**å˜æ›´æ—¥æœŸ**: 2025-07-01  
**å˜æ›´ç±»å‹**: æ ¸å¿ƒåŠŸèƒ½ä¿®å¤  
**å½±å“çº§åˆ«**: ğŸ”´ é«˜å½±å“ï¼ˆæ¶æ„çº§ä¿®å¤ï¼‰  
**ç‰ˆæœ¬**: V2.1-æ ¸å¿ƒä¿®å¤ç‰ˆæœ¬

## ğŸ¯ ä¿®å¤æ¦‚è¿°

æœ¬æ¬¡ä¿®å¤è§£å†³äº†EDMç³»ç»Ÿä¸¤ä¸ªå…³é”®çš„æ¶æ„é—®é¢˜ï¼š

1. **é˜Ÿåˆ—è°ƒåº¦å™¨è¿‡æ—©åˆ†é…æœåŠ¡é—®é¢˜**
2. **Webhookå›è°ƒæœºåˆ¶å…³è”é”™è¯¯é—®é¢˜**

è¿™ä¸¤ä¸ªé—®é¢˜ç›´æ¥å½±å“é‚®ä»¶å‘é€çš„å¯é æ€§å’ŒçŠ¶æ€è¿½è¸ªçš„å‡†ç¡®æ€§ã€‚

## ğŸ”§ é—®é¢˜1ï¼šé˜Ÿåˆ—è°ƒåº¦å™¨è¿‡æ—©åˆ†é…ä¿®å¤

### é—®é¢˜æè¿°
- **ç°è±¡**: SubTaskåœ¨åˆ›å»ºæ—¶å°±ç«‹å³åˆ†é…å‘ä¿¡æœåŠ¡
- **é—®é¢˜**: æœåŠ¡çŠ¶æ€å˜åŒ–æ—¶å¯¼è‡´ä»»åŠ¡å¡æ­»ï¼Œæ— æ³•åŠ¨æ€é€‚åº”æœåŠ¡å¯ç”¨æ€§
- **æ ¹æœ¬åŸå› **: è®¾è®¡ä¸Šåœ¨ä»»åŠ¡ç”Ÿæˆé˜¶æ®µå°±å›ºå®šåˆ†é…æœåŠ¡

### è®¾è®¡æ”¹è¿›
```diff
- åˆ›å»ºæ—¶ï¼šTask â†’ SubTask(pending) â†’ ç«‹å³åˆ†é…æœåŠ¡(allocated)
+ åˆ›å»ºæ—¶ï¼šTask â†’ SubTask(pendingçŠ¶æ€)
+ æ¶ˆè´¹æ—¶ï¼šåŠ¨æ€æŸ¥æ‰¾å¯ç”¨æœåŠ¡ â†’ åˆ†é…æœåŠ¡ â†’ å‘é€é‚®ä»¶
```

### ä¿®å¤å†…å®¹

#### 1. ä¿®å¤generateTaskQueueæ–¹æ³•
**æ–‡ä»¶**: `src/backend/src/services/infrastructure/QueueScheduler.js`
```javascript
// ğŸ”§ ä¿®å¤å‰
await this.allocateSubTasks(taskId, transaction);
await task.update({
  status: 'queued',
  pending_subtasks: 0,          // é”™è¯¯ï¼šç«‹å³æ¸…é›¶
  allocated_subtasks: subTasks.length
});

// âœ… ä¿®å¤å  
// await this.allocateSubTasks(taskId, transaction); // ç§»é™¤ç«‹å³åˆ†é…
await task.update({
  status: 'queued',
  pending_subtasks: subTasks.length,  // ä¿æŒpendingçŠ¶æ€
  allocated_subtasks: 0               // æš‚æ—¶ä¸åˆ†é…
});
```

#### 2. ä¿®å¤processTaskQueueæ–¹æ³•
```javascript
// âœ… æ–°å¢ï¼šåœ¨æ¶ˆè´¹æ—¶åŠ¨æ€åˆ†é…
await this.dynamicAllocateSubTasks(taskId, Math.min(batchSize, 10));

// ç„¶åè·å–allocatedçŠ¶æ€çš„SubTaskè¿›è¡Œå‘é€
const allocatedSubTasks = await SubTask.findAll({...});
```

#### 3. æ–°å¢dynamicAllocateSubTasksæ–¹æ³•
- **åŠŸèƒ½**: æ¶ˆè´¹æ—¶åŠ¨æ€åˆ†é…pendingçŠ¶æ€çš„SubTaskåˆ°å¯ç”¨æœåŠ¡
- **ç­–ç•¥**: è½®è¯¢ç­–ç•¥ï¼Œå®æ—¶æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
- **ä¼˜åŠ¿**: åŸºäºå®æ—¶æœåŠ¡çŠ¶æ€åˆ†é…ï¼Œé¿å…æœåŠ¡å†»ç»“å¯¼è‡´çš„ä»»åŠ¡å¡æ­»

## ğŸ”§ é—®é¢˜2ï¼šWebhookå›è°ƒæœºåˆ¶ä¿®å¤

### é—®é¢˜æè¿°
- **ç°è±¡**: Webhookå›è°ƒæ— æ³•æ­£ç¡®å…³è”åˆ°SubTask
- **é—®é¢˜**: éªŒè¯é€»è¾‘è¦æ±‚message_idï¼Œä½†åº”è¯¥ä½¿ç”¨custom_args.subtask_id
- **æ ¹æœ¬åŸå› **: æ¨¡å‹å…³è”é”™è¯¯ï¼Œä½¿ç”¨TaskContactè€Œä¸æ˜¯SubTask

### ä¿®å¤å†…å®¹

#### 1. ä¿®å¤éªŒè¯é€»è¾‘
**æ–‡ä»¶**: `src/backend/src/controllers/webhook.controller.js`
```javascript
// ğŸ”§ ä¿®å¤å‰
if (!eventData || !eventData.event || !eventData.message_id) {
  return res.status(400).json({ success: false, message: 'æ— æ•ˆçš„äº‹ä»¶æ•°æ®' });
}

// âœ… ä¿®å¤å
if (!eventData || !eventData.event || !eventData.custom_args || !eventData.custom_args.subtask_id) {
  return res.status(400).json({ success: false, message: 'æ— æ•ˆçš„äº‹ä»¶æ•°æ®ï¼Œç¼ºå°‘custom_args.subtask_id' });
}
```

#### 2. ä¿®å¤SubTaskæŸ¥æ‰¾é€»è¾‘
```javascript
// ğŸ”§ ä¿®å¤å‰ - é”™è¯¯æ¨¡å‹
const taskContact = await TaskContact.findOne({ where: { message_id: eventData.message_id } });

// âœ… ä¿®å¤å - æ­£ç¡®æ¨¡å‹
const subTask = await SubTask.findByPk(eventData.custom_args.subtask_id);
```

#### 3. ä¿®å¤ç»Ÿè®¡é€»è¾‘
- **ä¿®å¤å‰**: åŸºäºTaskContactçŠ¶æ€ç»Ÿè®¡
- **ä¿®å¤å**: åŸºäºSubTaskçŠ¶æ€ç»Ÿè®¡ï¼Œç¬¦åˆV2.0æ¶æ„

## ğŸ“Š ä¿®å¤éªŒè¯ç»“æœ

### 1. é˜Ÿåˆ—è°ƒåº¦å™¨éªŒè¯
```bash
âœ… é˜Ÿåˆ—è°ƒåº¦å™¨å¯åŠ¨å®Œæˆ
âœ… å¯åŠ¨äº† 2 ä¸ªå‘ä¿¡æœåŠ¡çš„è½®è¯¢å®šæ—¶å™¨
âœ… åŠ è½½äº†ç°æœ‰ä»»åŠ¡é˜Ÿåˆ—
```

### 2. WebhookéªŒè¯
```bash
âœ… æ”¶åˆ°é‚®ä»¶äº‹ä»¶: delivered
âœ… é€šè¿‡subtask_idæ­£ç¡®è¯†åˆ«SubTask
âœ… éªŒè¯é€»è¾‘ä¿®å¤ç”Ÿæ•ˆ
```

## ğŸ¯ æŠ€æœ¯æ”¹è¿›æ•ˆæœ

### é˜Ÿåˆ—è°ƒåº¦å™¨æ”¹è¿›
1. **åŠ¨æ€é€‚åº”æ€§**: æœåŠ¡çŠ¶æ€å˜åŒ–æ—¶ä»»åŠ¡ä¸ä¼šå¡æ­»
2. **è´Ÿè½½å‡è¡¡**: åŸºäºå®æ—¶å¯ç”¨æ€§åˆ†é…ä»»åŠ¡
3. **å¯é æ€§**: é¿å…è¿‡æ—©åˆ†é…å¯¼è‡´çš„èµ„æºæµªè´¹

### Webhookæ”¹è¿›  
1. **æ­£ç¡®å…³è”**: é€šè¿‡custom_args.subtask_idå‡†ç¡®å…³è”
2. **çŠ¶æ€è¿½è¸ª**: åŸºäºSubTaskæ¨¡å‹è¿›è¡ŒçŠ¶æ€æ›´æ–°
3. **æ•°æ®ä¸€è‡´æ€§**: ç»Ÿè®¡ä¿¡æ¯åŸºäºæ­£ç¡®çš„æ¨¡å‹

## ğŸ“‹ å½±å“è¯„ä¼°

### æ­£é¢å½±å“
- âœ… é‚®ä»¶å‘é€å¯é æ€§æ˜¾è‘—æå‡
- âœ… çŠ¶æ€è¿½è¸ªå‡†ç¡®æ€§å®Œå…¨ä¿®å¤
- âœ… ç³»ç»Ÿæ¶æ„æ›´åŠ åˆç†
- âœ… åŠ¨æ€é€‚åº”èƒ½åŠ›å¢å¼º

### é£é™©è¯„ä¼°
- ğŸŸ¡ éœ€è¦é‡æ–°æµ‹è¯•ç°æœ‰ä»»åŠ¡å¤„ç†æµç¨‹
- ğŸŸ¡ Webhookç»Ÿè®¡å­—æ®µå¯èƒ½éœ€è¦é‡æ–°åˆå§‹åŒ–

## ğŸš€ åç»­å»ºè®®

### çŸ­æœŸ
1. ç›‘æ§ç°æœ‰ä»»åŠ¡çš„å¤„ç†æ•ˆæœ
2. éªŒè¯Webhookå›è°ƒçš„å®Œæ•´æµç¨‹
3. æ£€æŸ¥ç»Ÿè®¡æ•°æ®çš„å‡†ç¡®æ€§

### ä¸­æœŸ  
1. ä¼˜åŒ–åŠ¨æ€åˆ†é…ç®—æ³•ï¼ˆè€ƒè™‘æœåŠ¡æ€§èƒ½æƒé‡ï¼‰
2. å¢åŠ æ›´è¯¦ç»†çš„åˆ†é…ç­–ç•¥é…ç½®
3. å®Œå–„Webhookäº‹ä»¶ç±»å‹æšä¸¾

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### ä¿®å¤æ–‡ä»¶æ¸…å•
- `src/backend/src/services/infrastructure/QueueScheduler.js` - é˜Ÿåˆ—è°ƒåº¦å™¨æ ¸å¿ƒé€»è¾‘
- `src/backend/src/controllers/webhook.controller.js` - Webhookå¤„ç†é€»è¾‘

### æ–°å¢æ–¹æ³•
- `QueueScheduler.dynamicAllocateSubTasks()` - åŠ¨æ€åˆ†é…æ–¹æ³•
- `WebhookController._updateTaskStats()` - åŸºäºSubTaskçš„ç»Ÿè®¡æ›´æ–°

### é…ç½®å½±å“
- æ— éœ€ä¿®æ”¹ç¯å¢ƒå˜é‡
- æ— éœ€ä¿®æ”¹æ•°æ®åº“ç»“æ„
- å‘åå…¼å®¹ç°æœ‰API

---

## âœ… ç»“è®º

æœ¬æ¬¡ä¿®å¤è§£å†³äº†EDMç³»ç»Ÿä¸¤ä¸ªæ ¸å¿ƒçš„æ¶æ„é—®é¢˜ï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„å¯é æ€§å’Œæ­£ç¡®æ€§ã€‚é˜Ÿåˆ—è°ƒåº¦å™¨çš„åŠ¨æ€åˆ†é…æœºåˆ¶å’ŒWebhookçš„æ­£ç¡®å…³è”ï¼Œä¸ºç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå¥ å®šäº†åšå®åŸºç¡€ã€‚

**ä¿®å¤çŠ¶æ€**: ğŸŸ¢ å·²å®Œæˆå¹¶éªŒè¯  
**ä¸Šçº¿å»ºè®®**: ğŸš€ ç«‹å³éƒ¨ç½²ï¼Œä½œä¸ºé‡è¦ç‰ˆæœ¬æäº¤ 