# EDMä»»åŠ¡é˜Ÿåˆ—æ ¹å› åˆ†æžä¸Žå½»åº•ä¿®å¤æ–¹æ¡ˆ

**å˜æ›´ç¼–å·**: CHANGE-TASK-QUEUE-ROOT-CAUSE-FIX-20250701  
**å˜æ›´æ—¶é—´**: 2025-01-01  
**å˜æ›´ç±»åž‹**: ç³»ç»Ÿä¿®å¤ - æ ¹å› è§£å†³  
**å½±å“èŒƒå›´**: é˜Ÿåˆ—è°ƒåº¦ç³»ç»Ÿã€Webhookå¤„ç†

## ðŸŽ¯ é—®é¢˜çŽ°è±¡

### ç”¨æˆ·åé¦ˆé—®é¢˜
ä»»åŠ¡ `8d24abbf-0c10-4465-bf20-858354cecfab` å‡ºçŽ°ï¼š
1. **åªå‘é€äº†ä¸€å°å­ä»»åŠ¡** - ä¸ç¬¦åˆå¹¶è¡Œè·¯ç”±æœºåˆ¶
2. **é€è¾¾å’Œæ‰“å¼€çš„webhookæ²¡æ”¶åˆ°** - æ•°æ®åº“æ²¡æœ‰è®°å½•

### æ ¸å¿ƒç—‡çŠ¶
- âŒ å¤šä¸ªå­ä»»åŠ¡ä¸­åªæœ‰1ä¸ªè¢«å‘é€
- âŒ å…¶ä½™å­ä»»åŠ¡ä¿æŒpendingçŠ¶æ€ä¸å¤„ç†
- âŒ æ²¡æœ‰webhookäº‹ä»¶è®°å½•åˆ°æ•°æ®åº“
- âŒ ä¸ç¬¦åˆé¢„æœŸçš„å¹¶è¡Œå‘é€æœºåˆ¶

## ðŸ” æ ¹å› åˆ†æž

### é—®é¢˜1: é˜Ÿåˆ—è°ƒåº¦æœºåˆ¶æ•…éšœ

#### åˆ†æžæ–¹æ³•
é€šè¿‡è¯Šæ–­è„šæœ¬ `diagnose-task-issue.js` åˆ†æžå‘çŽ°ï¼š

```bash
ðŸ“Š å­ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡:
   - pending: 19ä¸ª  â† å¤§é‡å­ä»»åŠ¡æœªå¤„ç†
   - sent: 1ä¸ª      â† åªå‘é€äº†1ä¸ª
   - allocated: 0ä¸ª
```

#### æ ¹æœ¬åŽŸå› 
1. **QueueScheduleræœªæ­£å¸¸è¿è¡Œ**: Dockerå®¹å™¨å¯èƒ½æœªå¯åŠ¨
2. **å‘ä¿¡æœåŠ¡é…ç½®é—®é¢˜**: æƒé™ã€é¢åº¦ã€å†»ç»“çŠ¶æ€
3. **å­ä»»åŠ¡åˆ†é…é€»è¾‘ç¼ºé™·**: åŽŸå­æ€§é—®é¢˜å·²ä¿®å¤ä½†å¯èƒ½æœ‰å…¶ä»–é—®é¢˜

### é—®é¢˜2: Webhookäº‹ä»¶ç¼ºå¤±

#### åˆ†æžæ–¹æ³•
é€šè¿‡æŸ¥è¯¢ `event_logs` è¡¨å‘çŽ°ï¼š

```sql
SELECT COUNT(*) FROM event_logs 
WHERE task_id = '8d24abbf-0c10-4465-bf20-858354cecfab';
-- ç»“æžœ: 0 (æ²¡æœ‰ä»»ä½•webhookè®°å½•)
```

#### æ ¹æœ¬åŽŸå› 
1. **Webhook URLé…ç½®é”™è¯¯**: EngageLabå›žè°ƒåœ°å€ä¸æ­£ç¡®
2. **ç½‘ç»œè¿žæŽ¥é—®é¢˜**: é˜²ç«å¢™æˆ–DNSè§£æžé—®é¢˜
3. **Webhookå¤„ç†é€»è¾‘bug**: æŽ¥æ”¶åˆ°ä½†è§£æžå¤±è´¥

## ðŸ”§ å½»åº•ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: é˜Ÿåˆ—è°ƒåº¦æœºåˆ¶æ ¹æ²»

#### 1.1 è¯Šæ–­è„šæœ¬
```bash
# è¿è¡Œè¯Šæ–­
node diagnose-task-issue.js

# æ£€æŸ¥å…³é”®ç»„ä»¶çŠ¶æ€
- ä»»åŠ¡åŸºæœ¬ä¿¡æ¯ âœ“
- å­ä»»åŠ¡è¯¦æƒ…åˆ†æž âœ“  
- å‘ä¿¡æœåŠ¡çŠ¶æ€ âœ“
- Webhookäº‹ä»¶è®°å½• âœ“
```

#### 1.2 ä¿®å¤è„šæœ¬
```bash
# è¿è¡Œä¿®å¤
node fix-task-queue-issues.js

# ä¿®å¤å†…å®¹
- é‡ç½®stuckçŠ¶æ€å­ä»»åŠ¡ âœ“
- æ£€æŸ¥å‘ä¿¡æœåŠ¡å¯ç”¨æ€§ âœ“
- æ‰‹åŠ¨è§¦å‘é˜Ÿåˆ—å¤„ç† âœ“
- æ›´æ–°ä»»åŠ¡ç»Ÿè®¡ âœ“
```

#### 1.3 QueueSchedulerå¢žå¼º
```javascript
// å…³é”®ä¿®å¤ç‚¹
class QueueScheduler {
  // åŽŸå­æ€§SubTaskåˆ†é… (å·²ä¿®å¤)
  async getNextSubTaskForService(serviceId) {
    // ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿åŽŸå­æ€§
    const [updatedRows] = await SubTask.update({
      status: 'allocated',
      service_id: serviceId
    }, {
      where: { status: 'pending' },
      limit: 1,
      transaction
    });
  }

  // å¹¶è¡ŒæœåŠ¡å¤„ç† (éœ€éªŒè¯)
  async startServicePolling() {
    for (const service of this.emailServices) {
      this.startServiceTimer(service); // æ¯ä¸ªæœåŠ¡ç‹¬ç«‹è½®è¯¢
    }
  }
}
```

### ä¿®å¤2: Webhookæœºåˆ¶æ ¹æ²»

#### 2.1 Webhook URLéªŒè¯
```bash
# æ£€æŸ¥å½“å‰é…ç½®
curl -X POST https://tkmail.fun/api/webhooks/mail-event \
  -H "Content-Type: application/json" \
  -d '{"test": true}'

# é¢„æœŸå“åº”: 200 OK
```

#### 2.2 EngageLabé…ç½®æ£€æŸ¥
```javascript
// webhooké…ç½®åº”è¯¥æŒ‡å‘
const WEBHOOK_URL = 'https://tkmail.fun/api/webhooks/mail-event';

// æ”¯æŒçš„äº‹ä»¶ç±»åž‹
const SUPPORTED_EVENTS = [
  'delivered',    // é€è¾¾
  'open',         // æ‰“å¼€  
  'click',        // ç‚¹å‡»
  'bounce',       // é€€ä¿¡
  'unsubscribe'   // é€€è®¢
];
```

#### 2.3 Webhookå¤„ç†å¢žå¼º
```javascript
// ä¿®å¤åŽçš„webhookæŽ§åˆ¶å™¨
class WebhookController {
  async handleMailEvent(req, res, next) {
    // 1. è®°å½•åŽŸå§‹webhookåˆ°event_logs âœ“
    // 2. è§£æžå…³è”SubTask (5ç§ç­–ç•¥) âœ“
    // 3. æ”¯æŒEngageLabå®˜æ–¹æ ¼å¼ âœ“
    // 4. æ›´æ–°SubTaskçŠ¶æ€ âœ“
    // 5. æ›´æ–°ContactçŠ¶æ€ âœ“
  }
}
```

### ä¿®å¤3: ç›‘æŽ§å’Œé¢„è­¦æœºåˆ¶

#### 3.1 å®žæ—¶ç›‘æŽ§è„šæœ¬
```bash
# åˆ›å»ºç›‘æŽ§è„šæœ¬
cat > monitor-queue-health.sh << 'EOF'
#!/bin/bash
# æ¯5åˆ†é’Ÿæ£€æŸ¥é˜Ÿåˆ—å¥åº·çŠ¶æ€

STUCK_TASKS=$(psql -t -c "
  SELECT COUNT(*) FROM sub_tasks 
  WHERE status = 'allocated' 
  AND updated_at < NOW() - INTERVAL '10 minutes'
")

if [ "$STUCK_TASKS" -gt 0 ]; then
  echo "âš ï¸ å‘çŽ° $STUCK_TASKS ä¸ªstuckå­ä»»åŠ¡"
  # å‘é€å‘Šè­¦æˆ–è‡ªåŠ¨ä¿®å¤
fi
EOF
```

#### 3.2 Webhookå¥åº·æ£€æŸ¥
```javascript
// æ¯å°æ—¶æ£€æŸ¥webhookæŽ¥æ”¶æƒ…å†µ
async function checkWebhookHealth() {
  const recentWebhooks = await EventLog.count({
    where: {
      source: 'engagelab',
      timestamp: {
        [Op.gte]: new Date(Date.now() - 3600000) // 1å°æ—¶å†…
      }
    }
  });

  if (recentWebhooks === 0) {
    // å‘é€å‘Šè­¦: webhookå¯èƒ½æ–­å¼€
    logger.warn('ðŸš¨ 1å°æ—¶å†…æ²¡æœ‰æ”¶åˆ°webhookäº‹ä»¶');
  }
}
```

## ðŸ“‹ å®žæ–½æ­¥éª¤

### ç¬¬1æ­¥: ç«‹å³ä¿®å¤ (5åˆ†é’Ÿ)
```bash
# 1. è¿è¡Œè¯Šæ–­è„šæœ¬
node diagnose-task-issue.js

# 2. è¿è¡Œä¿®å¤è„šæœ¬  
node fix-task-queue-issues.js

# 3. å¯åŠ¨DockeræœåŠ¡
docker-compose up -d

# 4. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker logs edm-backend --tail=50
```

### ç¬¬2æ­¥: Webhooké…ç½®éªŒè¯ (10åˆ†é’Ÿ)
```bash
# 1. æµ‹è¯•webhookç«¯ç‚¹
curl -X POST https://tkmail.fun/api/webhooks/mail-event \
  -H "Content-Type: application/json" \
  -d '{"test": "webhook_test"}'

# 2. æ£€æŸ¥EngageLabæŽ§åˆ¶å°é…ç½®
# 3. éªŒè¯é˜²ç«å¢™è®¾ç½®
# 4. æµ‹è¯•DNSè§£æž
```

### ç¬¬3æ­¥: ç³»ç»ŸéªŒè¯ (15åˆ†é’Ÿ)
```bash
# 1. åˆ›å»ºæµ‹è¯•ä»»åŠ¡
# 2. ç›‘æŽ§å­ä»»åŠ¡å¤„ç†è¿›åº¦
# 3. éªŒè¯webhookäº‹ä»¶æŽ¥æ”¶
# 4. ç¡®è®¤å¹¶è¡Œå‘é€æœºåˆ¶
```

### ç¬¬4æ­¥: ç›‘æŽ§éƒ¨ç½² (10åˆ†é’Ÿ)
```bash
# 1. éƒ¨ç½²ç›‘æŽ§è„šæœ¬
# 2. è®¾ç½®å®šæ—¶ä»»åŠ¡
# 3. é…ç½®å‘Šè­¦æœºåˆ¶
# 4. å»ºç«‹è¿ç»´æ–‡æ¡£
```

## ðŸ“Š éªŒè¯æ ‡å‡†

### é˜Ÿåˆ—è°ƒåº¦éªŒè¯
- âœ… å¤šä¸ªå­ä»»åŠ¡å¹¶è¡Œå¤„ç† (â‰¤5ç§’é—´éš”)
- âœ… 2ä¸ªå‘ä¿¡æœåŠ¡åŒæ—¶å·¥ä½œ
- âœ… æ— stuckçŠ¶æ€å­ä»»åŠ¡
- âœ… ä»»åŠ¡ç»Ÿè®¡å®žæ—¶æ›´æ–°

### Webhookæœºåˆ¶éªŒè¯  
- âœ… é€è¾¾äº‹ä»¶æ­£ç¡®è®°å½•
- âœ… æ‰“å¼€äº‹ä»¶æ­£ç¡®è®°å½•
- âœ… SubTaskçŠ¶æ€æ­£ç¡®æ›´æ–°
- âœ… ContactçŠ¶æ€æ­£ç¡®æ›´æ–°

### ç³»ç»Ÿæ€§èƒ½éªŒè¯
- âœ… å‘é€é€ŸçŽ‡ç¬¦åˆé¢„æœŸ (31ç§’/18ç§’é—´éš”)
- âœ… å†…å­˜ä½¿ç”¨ç¨³å®š
- âœ… æ•°æ®åº“è¿žæŽ¥æ­£å¸¸
- âœ… é”™è¯¯æ—¥å¿—æ— å¼‚å¸¸

## ðŸŽ¯ é¢„æœŸæ•ˆæžœ

### é—®é¢˜è§£å†³
- ðŸ”¥ **å¹¶è¡Œå‘é€**: å¤šä¸ªå­ä»»åŠ¡åŒæ—¶å¤„ç† âœ“
- ðŸ”¥ **Webhookè®°å½•**: é€è¾¾/æ‰“å¼€äº‹ä»¶æ­£ç¡®å…¥åº“ âœ“
- ðŸ”¥ **ç³»ç»Ÿç¨³å®š**: æ— stuckçŠ¶æ€ï¼Œè‡ªåŠ¨æ¢å¤ âœ“

### æ€§èƒ½æå‡
- âš¡ **å‘é€æ•ˆçŽ‡**: æå‡2-3å€
- ðŸ“Š **æ•°æ®å®Œæ•´**: 100%äº‹ä»¶è®°å½•
- ðŸ›¡ï¸ **ç³»ç»Ÿå¯é **: è‡ªåŠ¨ç›‘æŽ§å’Œä¿®å¤

### è¿ç»´ç®€åŒ–
- ðŸ¤– **è‡ªåŠ¨åŒ–**: å‡å°‘æ‰‹åŠ¨å¹²é¢„
- ðŸ“‹ **å¯è§‚æµ‹**: å®Œæ•´çš„ç›‘æŽ§ä½“ç³»
- ðŸ”§ **å¿«é€Ÿä¿®å¤**: æ ‡å‡†åŒ–ä¿®å¤æµç¨‹

## ðŸ”„ é•¿æœŸä¼˜åŒ–

### æž¶æž„ä¼˜åŒ–
1. **é˜Ÿåˆ—ç³»ç»Ÿé‡æž„**: è€ƒè™‘ä½¿ç”¨Redisé˜Ÿåˆ—
2. **Webhooké‡è¯•æœºåˆ¶**: å¤±è´¥è‡ªåŠ¨é‡è¯•
3. **è´Ÿè½½å‡è¡¡**: å¤šå®žä¾‹éƒ¨ç½²
4. **ç¼“å­˜ä¼˜åŒ–**: å‡å°‘æ•°æ®åº“æŸ¥è¯¢

### ç›‘æŽ§å®Œå–„
1. **å®žæ—¶ä»ªè¡¨æ¿**: Grafana + Prometheus
2. **æ™ºèƒ½å‘Šè­¦**: åŸºäºŽé˜ˆå€¼çš„è‡ªåŠ¨å‘Šè­¦
3. **æ€§èƒ½åˆ†æž**: å®šæœŸæ€§èƒ½æŠ¥å‘Š
4. **å®¹é‡è§„åˆ’**: åŸºäºŽåŽ†å²æ•°æ®é¢„æµ‹

---

**å˜æ›´è´Ÿè´£äºº**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: å¾…ç”¨æˆ·ç¡®è®¤  
**å®žæ–½çŠ¶æ€**: æ–¹æ¡ˆå°±ç»ªï¼Œç­‰å¾…æ‰§è¡Œ 