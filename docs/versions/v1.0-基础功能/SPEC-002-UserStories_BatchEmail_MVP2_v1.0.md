# 用户故事卡片：批量发信模块 (MVP 方案二)

## 功能清单与用户故事

### F_NEW_TEMPLATE: 邮件模板管理与编辑

*   **F_NEW_TEMPLATE.1: 模板创建与富文本编辑**
    *   **US_TPL01.1: 创建新的邮件模板**
        *   **角色：** 运营人员
        *   **行为：** 创建一个新的邮件模板
        *   **目的：** 能够设计和保存用于邮件发送的内容。
        *   **验收条件：**
            1.  运营人员可以为模板指定一个名称。
            2.  运营人员可以使用富文本编辑器 (推荐 TinyMCE，需确保其输出邮件兼容的 HTML) 来编辑模板内容。
            3.  编辑器应提供基础的格式化选项（加粗、斜体、列表、链接、图片插入等）。
            4.  模板内容可以包含占位符（如 `{{nickname}}`, `{{unsubscribe_link}}`）。
            5.  模板可以被保存到数据库 (`templates` 表，包含 `id`, `name`, `content`, `created_at`, `updated_at`)。
    *   **US_TPL01.2: 编辑现有邮件模板**
        *   **角色：** 运营人员
        *   **行为：** 修改已存在的邮件模板
        *   **目的：** 更新或调整邮件内容。
        *   **验收条件：**
            1.  运营人员可以从模板列表中选择一个模板进行编辑。
            2.  富文本编辑器加载模板的现有内容。
            3.  修改后可以保存，更新 `updated_at` 字段。
    *   **US_TPL01.3: 模板列表与预览**
        *   **角色：** 运营人员
        *   **行为：** 查看和预览邮件模板
        *   **目的：** 管理和选择合适的模板。
        *   **验收条件：**
            1.  系统展示所有已创建的邮件模板列表（名称、创建/修改日期）。
            2.  运营人员可以预览选定模板的渲染效果（近似邮件客户端效果）。

*   **F_NEW_TEMPLATE.2: 模板组 (Template Set) 管理**
    *   **US_TPL02.1: 创建模板组**
        *   **角色：** 运营人员
        *   **行为：** 创建一个模板组
        *   **目的：** 将多个相关的邮件模板组织在一起，用于 A/B 测试或内容轮换。
        *   **验收条件：**
            1.  运营人员可以为模板组指定一个名称。
            2.  运营人员可以从现有的邮件模板列表中选择一个或多个模板添加到该组。
            3.  模板组信息 (ID, 名称) 和关联关系 (`template_set_items` 表：`template_set_id`, `template_id`) 被正确保存。
    *   **US_TPL02.2: 管理模板组**
        *   **角色：** 运营人员
        *   **行为：** 编辑或删除模板组
        *   **目的：** 维护模板组的配置。
        *   **验收条件：**
            1.  可以向模板组中添加或移除邮件模板。
            2.  可以修改模板组的名称。
            3.  可以删除模板组 (若无任务 `task` 关联，或提示风险并确认)。

### F01: 任务组 (Campaign) 创建 (单阶段)

*   **US01.1: 创建单阶段 Campaign**
    *   **角色：** 运营人员
    *   **行为：** 创建一个新的 Campaign
    *   **目的：** 能够启动一个独立的邮件发送批次或活动。
    *   **验收条件：**
        1.  运营人员可以在系统中输入 Campaign 名称。
        2.  运营人员可以为 Campaign 指定一个开始发送时间 (`start_time`)。
        3.  创建成功后，Campaign 的初始状态为 `draft`。
        4.  Campaign 信息（ID, 名称, `start_time`, `status`, `created_by`）被正确保存到数据库。
    *   **边缘场景：**
        *   开始时间不能早于当前时间。
        *   Campaign 名称不能为空。
*   **US01.2: 查看 Campaign 列表**
    *   **角色：** 运营人员
    *   **行为：** 查看已创建的 Campaign 列表
    *   **目的：** 了解当前所有的邮件发送活动及其基本状态。
    *   **验收条件：**
        1.  列表中应显示 Campaign ID, 名称, `start_time`, 状态 (`draft` / `active` / `paused` / `completed`)。
        2.  支持按创建时间或 `start_time` 排序。
    *   **边缘场景：**
        *   列表为空时，应有友好提示。

### F02: 任务 (Task) 配置

*   **US02.1: 在 Campaign 内创建 Task**
    *   **角色：** 运营人员
    *   **行为：** 在一个已存在的 Campaign 内创建一个 Task
    *   **目的：** 为 Campaign 定义具体的执行单元。
    *   **验收条件：**
        1.  运营人员可以选择一个 `draft` 状态的 Campaign 来添加 Task。
        2.  运营人员可以为 Task 指定一个名称。
        3.  Task 的 `plan_time` 默认等于其所属 Campaign 的 `start_time` (MVP 简化：一个 Campaign 仅一个 Task，Task 的 `plan_time` 直接使用 Campaign 的 `start_time`)。
        4.  Task 创建后状态为 `draft`。
        5.  Task 信息 (ID, `campaign_id`, 名称, `plan_time`, `status`, `template_set_id`, `recipient_rule`) 被正确保存。
    *   **边缘场景：**
        *   Task 名称不能为空。
        *   非 `draft` 状态的 Campaign 不能添加 Task。

### F03: 收件人选择 (支持系统标签初筛)

*   **US03.1: 通过标签选择收件人**
    *   **角色：** 运营人员
    *   **行为：** 为 Task 配置收件人规则
    *   **目的：** 精准定位目标联系人。
    *   **验收条件：**
        1.  运营人员可以选择一个或多个已存在的 `contact` 标签来定义收件人集合 (形成 `include_tags` 列表)。
        2.  运营人员可以选择一个或多个已存在的 `contact` 标签用于排除收件人 (形成 `exclude_tags` 列表)。
        3.  (MVP 简化) 运营人员可以选择包含一个基础的系统标签 (例如 `system:unopened_last_campaign` - 指上一个同用户创建的已完成Campaign)。
        4.  (MVP 简化) 运营人员可以选择剔除一个基础的系统标签。
        5.  选择的规则能被正确保存到 Task 的 `recipient_rule` (JSON 格式，例如: `{"include_tags": ["tag_A", "tag_B"], "exclude_tags": ["tag_C"], "include_system_labels": ["unopened_last_campaign"], "exclude_system_labels": []}` )。
        6.  系统能根据规则预览大致的收件人数（可选，初期可不实现）。
    *   **边缘场景：**
        *   未选择任何包含标签时，提示用户。
        *   选择的标签组合下没有联系人。

### F04: 任务中关联模板组 (原F04修订)

*   **US04.1: 为 Task 关联模板组**
    *   **角色：** 运营人员
    *   **行为：** 为 Task 选择一个模板组
    *   **目的：** 定义发送邮件时使用的具体内容集合。
    *   **验收条件：**
        1.  运营人员可以从 `template_set` 列表中选择一个关联到 Task。
        2.  `template_set_id` 被正确保存到 Task。
    *   **边缘场景：**
        *   没有可用的模板组。
        *   选择的模板组是空的（不包含任何模板）。
*   **US04.2: 模板组内模板轮询使用**
    *   **角色：** 系统
    *   **行为：** 在发送邮件时从模板组中选择模板
    *   **目的：** 实现 A/B 测试或内容多样性。
    *   **验收条件：**
        1.  当 Task 执行发送时，如果关联的 `template_set` 包含多个模板，系统应按顺序轮询使用这些模板为当前批次的联系人分配模板。
        2.  例如，有模板 T1, T2, T3，则发送给第一个联系人用 T1，第二个用 T2，第三个用 T3，第四个用 T1，以此类推。
    *   **边缘场景：**
        *   模板组只包含一个模板时，始终使用该模板。

### F05: 智能发件服务路由 (自动选择)

*   **US05.1: 系统自动选择可用发件服务**
    *   **角色：** 系统
    *   **行为：** 在 Task 即将发送时，自动选择合适的发件服务
    *   **目的：** 确保邮件通过健康且有配额的服务发出，无需人工干预。
    *   **验收条件：**
        1.  系统获取所有 `sender_service` 中 `health_status == 'active'` 且 `used_today < daily_quota` 的服务。
        2.  系统按照 `daily_quota - used_today` (剩余可用额度) 对服务进行降序排序。
        3.  系统选择排序后的第一个服务用于发送（MVP简化：初期先只用一个最佳服务，不并行拆分到多个服务）。
        4.  被选中的服务信息被记录（例如，在 `task_send_log` 或 `event_log` 中关联 `sender_service_id`）。
    *   **边缘场景：**
        *   没有符合条件的发件服务。
*   **US05.2: 任务因无可用服务而暂停**
    *   **角色：** 系统
    *   **行为：** 当没有可用的发件服务时，暂停 Task
    *   **目的：** 避免任务失败，等待人工干预或服务恢复。
    *   **验收条件：**
        1.  如果 `pick_services` 算法返回空列表，Task 的状态从 `scheduled` (或 `sending` 初期检查时) 变为 `paused`。
        2.  系统应记录或通知运营人员/管理员任务暂停的原因（无可用服务）。
        3.  处于 `paused` 状态的任务不会被调度器自动执行，直到其状态被手动改回 `scheduled`。
    *   **边缘场景：**
        *   多个任务同时因无服务而暂停。

### F06: 任务调度与执行

*   **US06.1: 系统按计划时间调度 Task**
    *   **角色：** 系统 (调度器)
    *   **行为：** 定期扫描并触发到期 Task 的执行流程
    *   **目的：** 自动化邮件发送过程。
    *   **验收条件：**
        1.  调度器按预设频率（如每分钟）检查所有 Campaign 下的 Task。
        2.  对于状态为 `scheduled` 且 `plan_time` 小于或等于当前时间的 Task，调度器将其状态更新为 `sending` 并启动发送流程 (实际发送交由任务队列)。
    *   **边缘场景：**
        *   调度器启动时有大量积压的到期任务。
        *   `plan_time` 设置为过去的时间。
*   **US06.2: Task 状态流转管理**
    *   **角色：** 系统
    *   **行为：** 管理 Task 在其生命周期中的状态变化
    *   **目的：** 清晰反映 Task 的当前处理阶段。
    *   **验收条件：**
        1.  Task 创建后为 `draft`。
        2.  运营人员确认配置无误后，可将 Task (或其所属 Campaign) 状态从 `draft` 更新为 `active` (对于 Campaign) / `scheduled` (对于 Task)。
        3.  调度器选中后，Task 状态变为 `sending`。
        4.  所有邮件尝试发送完毕（无论成功或部分失败，基于联系人批次处理完成）后，Task 状态变为 `finished`。
        5.  若发送过程中出现不可恢复的系统级错误（如数据库连接失败，或前置检查严重失败），Task 状态变为 `failed`。
        6.  若无可用发件服务，Task 状态变为 `paused` (见 US05.2)。
    *   **边缘场景：**
        *   在 `sending` 过程中系统重启（需考虑任务幂等性与恢复）。

### F07: 核心事件记录 (含追踪)

*   **US07.1: 记录邮件发送 (Send) 事件**
    *   **角色：** 系统
    *   **行为：** 为每个尝试发送的邮件记录 `send` 事件
    *   **目的：** 跟踪每封邮件的投递尝试。
    *   **验收条件：**
        1.  当系统尝试通过极光 API 为某个联系人发送邮件时，无论 API 调用成功与否，均在 `event_log` 表中记录一条类型为 `send` 的事件。
        2.  事件应包含 `contact_id`, `task_id`, `type='send'`, 时间戳 (`ts`)，发送使用的 `sender_service_id`，以及发送状态（如 `api_success` / `api_failed` 及错误信息）。
*   **US07.2: 记录邮件投递回执 (Delivered, Bounce) 事件**
    *   **角色：** 系统 (事件监听器/回调处理器)
    *   **行为：** 接收并记录极光 API 推送的邮件投递状态回执
    *   **目的：** 了解邮件的实际投递结果。
    *   **验收条件：**
        1.  系统需提供一个接收极光 API 回调的端点，能正确解析回调数据。
        2.  当收到 `delivered` (送达成功) 回执时，在 `event_log` 记录相应事件，包含 `contact_id`, `task_id`, `type='delivered'`, `ts`。
        3.  当收到 `bounce` (退信) 回执时，在 `event_log` 记录相应事件，包含 `contact_id`, `task_id`, `type='bounce'`, `ts`，以及退信原因。
*   **US07.3: 根据 Bounce 事件初步处理发件服务健康**
    *   **角色：** 系统
    *   **行为：** 当特定发件服务产生过多 Bounce 时，初步标记
    *   **目的：** 保护发件服务信誉。
    *   **验收条件：**
        1.  系统监控与某个 `sender_service` 关联的 `bounce` 事件。
        2.  如果一个 `sender_service` 在指定时间窗口内（例如 10 分钟）收到连续 3 次（或累计达到某个可配置阈值）的 `bounce` 事件，系统应将其 `health_status` 更新为 `frozen`。
        3.  冻结时应记录原因（如 "过多退信"）。
*   **US07.4: 实现邮件打开追踪 (Tracking Pixel)**
    *   **角色：** 系统
    *   **行为：** 在发送的邮件中嵌入追踪像素，并记录打开事件
    *   **目的：** 统计邮件的打开率。
    *   **验收条件：**
        1.  系统在邮件模板渲染时，自动在邮件内容末尾（或由模板指定 `{{tracking_pixel}}` 位置）插入一个唯一的、指向系统追踪端点的透明 1x1 像素图片标签 (`<img>`)。
        2.  该图片 URL 至少包含能关联到 `task_id` 和 `contact_id` 的唯一追踪标识 (例如 `event_uid`)。
        3.  当邮件客户端请求该图片 URL 时，系统记录一次 `open` 事件到 `event_log`，关联 `contact_id`, `task_id`, `type='open'`, `ts`。
        4.  该追踪端点应返回一个极小体积的透明图片响应 (e.g., GIF)。
    *   **边缘场景：**
        *   邮件客户端阻止图片加载。
        *   用户纯文本模式阅读邮件。
*   **US07.5: 实现邮件链接点击追踪 (Redirect Link)**
    *   **角色：** 系统
    *   **行为：** 重写邮件中的链接以进行点击追踪，并记录点击事件
    *   **目的：** 统计邮件中链接的点击率。
    *   **验收条件：**
        1.  系统在邮件模板渲染时，解析邮件内容中的所有 `<a>` 标签的 `href` 属性 (不包括明确标记为不追踪的链接，如退订链接)。
        2.  将原始 URL 替换为一个指向系统追踪中转端点的新 URL。该新 URL 需包含加密/编码的原始 URL，以及关联 `task_id`、`contact_id` 的唯一追踪标识 (`event_uid`)。
        3.  当用户点击邮件中的链接时，请求到达系统的中转端点。
        4.  中转端点记录一次 `click` 事件到 `event_log`，关联 `contact_id`, `task_id`, `type='click'`, `ts`, 以及被点击的原始 URL。
        5.  记录后，系统将用户 HTTP 302 重定向到原始 URL。
        6.  退订链接 (`unsubscribe_link`) 必须能被正确替换且不应被点击追踪 (或采用特定方式标记其为退订点击)。
    *   **边缘场景：**
        *   原始 URL 无效。
        *   处理包含复杂查询参数的 URL。

### F08: 任务与 Campaign 状态查看 (含追踪数据)

*   **US08.1: 查看 Campaign 和 Task 列表及状态与追踪统计**
    *   **角色：** 运营人员
    *   **行为：** 查看 Campaign 及其关联 Task 的列表、当前状态以及基础的追踪统计
    *   **目的：** 监控邮件发送活动的进展和效果。
    *   **验收条件：**
        1.  运营人员可以查看到所有 Campaign 的列表，包含名称、开始时间、状态。
        2.  点击某个 Campaign 可以看到其下属 Task 的列表，包含 Task 名称、计划发送时间、状态。
        3.  列表中应显示 Task 的基本统计数据：计划发送联系人数 (基于 `recipient_rule` 计算)，已尝试发送数 (基于 `send` 事件计数)，成功送达数 (基于 `delivered` 事件计数)，退信数 (基于 `bounce` 事件计数)，打开数 (基于 `open` 事件计数，独立用户)，点击数 (基于 `click` 事件计数，独立用户及总次数)。
    *   **边缘场景：**
        *   Campaign 下没有 Task。
        *   统计数据更新有延迟。

### F09: 发件服务管理 (极光 API)

*   **US09.1: 超级管理员管理发件服务 (极光)**
    *   **角色：** 超级管理员
    *   **行为：** 增、删、改、查发件服务 (Sender Service) 配置
    *   **目的：** 维护系统可用的邮件发送通道。
    *   **验收条件：**
        1.  超级管理员可以添加新的发件服务，类型明确为"极光 API"。
        2.  配置项应包括：服务名称, API Key, API Secret (需安全存储), `daily_quota` (每日发送上限), `throttle_sec` (或等效的 QPS/TPM，用于系统侧限流)。
        3.  可以编辑已存在的服务配置。
        4.  可以删除不再使用的服务 (若服务当前未被激活的任务使用，或有风险提示)。
        5.  可以查看所有服务的列表及其当前状态 (`active`/`frozen`)、当日已用额度 (`used_today`)。
    *   **边缘场景：**
        *   API Key 等凭证填写错误。
*   **US09.2: 超级管理员手动调整发件服务健康状态**
    *   **角色：** 超级管理员
    *   **行为：** 手动更改发件服务的 `health_status`
    *   **目的：** 在自动冻结或服务异常后进行人工干预。
    *   **验收条件：**
        1.  超级管理员可以将 `sender_service` 的状态从 `frozen` 改为 `active` (解冻)。
        2.  超级管理员可以将 `sender_service` 的状态从 `active` 改为 `frozen` (手动冻结)。
        3.  操作时可以记录原因。
    *   **边缘场景：**
        *   服务本身配置无效，解冻后立刻又因新发生的 Bounce 事件被自动冻结。

---
文档版本: v1.0
最后更新: {{CURRENT_DATE}} (此处将由系统自动填充实际日期) 