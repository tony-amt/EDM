# 页面结构说明：批量发信模块 (MVP 方案二 - 修订版 v1.1)

## I. 运营人员界面

### 1. 邮件模板管理 (F_NEW_TEMPLATE)

*   **P01: 邮件模板列表页 (`/templates`)**
    *   **页面目标：** 展示、搜索、创建和管理所有邮件模板。
    *   **输入项/操作：**
        *   搜索框（按模板名称搜索）。
        *   "创建新模板"按钮。
        *   模板列表：
            *   列：模板名称, 邮件标题, 创建日期, 修改日期, 操作（编辑, 预览, 删除 - 若无模板组关联）。
        *   分页组件。
    *   **输出项：**
        *   符合搜索条件的模板列表。
    *   **路径跳转：**
        *   点击"创建新模板" → P02。
        *   点击"编辑" → P02 (带模板数据)。
        *   点击"预览" → P03 (模态框/新页)。
        *   点击"删除" → 确认删除逻辑。
    *   **异常处理：**
        *   列表为空时友好提示。
        *   删除有关联的模板时提示。

*   **P02: 邮件模板编辑/创建页 (`/templates/new` 或 `/templates/:id/edit`)**
    *   **页面目标：** 创建或修改邮件模板，包括邮件标题和正文内容，并支持使用预定义变量。
    *   **输入项/操作：**
        *   表单：
            *   模板名称 (文本输入框)。
            *   **邮件标题** (文本输入框，支持插入 P11 定义的邮件变量 - 如 `{{contact.nickname}}`)。
            *   **邮件正文** (富文本编辑器 - TinyMCE)。
                *   编辑器工具栏：加粗, 斜体, 下划线, 字号, 字体, 颜色, 列表 (有序/无序), 链接插入/编辑, 图片插入 (支持上传或URL), 插入预定义邮件变量 (从P11定义的变量中选择列表，如 `{{contact.nickname}}`, `{{unsubscribe_link}}`, `{{tracking_pixel}}`), HTML源码编辑模式。
        *   "保存"按钮。
        *   "另存为新模板"按钮 (编辑时可选)。
        *   "预览"按钮。
        *   "返回列表"按钮/链接。
    *   **输出项：**
        *   成功/失败提示。
    *   **路径跳转：**
        *   保存成功 → P01。
        *   点击"预览" → P03 (预览时应能模拟变量替换效果，或提示变量如何显示)。
        *   点击"返回列表" → P01。
    *   **异常处理：**
        *   名称、邮件标题为空。
        *   保存失败提示。
    *   **页面字段结构 (对应 `templates` 表)：**
        *   `name`: String
        *   `subject`: String (邮件标题)
        *   `body`: Text (HTML, 邮件正文)

*   **P03: 邮件模板预览 (模态框或 `/templates/:id/preview`)**
    *   **页面目标：** 展示邮件模板（含标题和正文）在模拟邮件客户端中的渲染效果，并提示变量。
    *   **输入项/操作：**
        *   (可选) 切换设备预览（桌面/移动端）。
        *   关闭预览。
    *   **输出项：**
        *   模拟邮件标题 (显示含变量的标题)。
        *   渲染后的邮件正文内容 (显示含变量的正文)。
        *   (可选) 提供一个简单的输入区域，让用户临时输入几个变量的值，实时查看替换效果。
    *   **路径跳转：**
        *   关闭后返回 P01 或 P02。
    *   **异常处理：**
        *   模板内容为空或无法渲染。

### 2. 模板组管理 (F_NEW_TEMPLATE)

*   **P04: 模板组列表页 (`/template-sets`)**
    *   **页面目标：** 展示、创建和管理所有模板组。
    *   **输入项/操作：**
        *   "创建新模板组"按钮。
        *   模板组列表：
            *   列：模板组名称, 包含模板数, 创建日期, 操作（编辑, 删除 - 若无Task关联）。
        *   分页组件。
    *   **输出项：**
        *   模板组列表。
    *   **路径跳转：**
        *   点击"创建新模板组" → P05。
        *   点击"编辑" → P05 (带模板组数据)。
    *   **异常处理：**
        *   列表为空时友好提示。

*   **P05: 模板组编辑/创建页 (`/template-sets/new` 或 `/template-sets/:id/edit`)**
    *   **页面目标：** 创建或修改模板组及其包含的邮件模板。
    *   **输入项/操作：**
        *   表单：
            *   模板组名称 (文本输入框)。
            *   已选模板列表 (展示已选模板名称，可移除)。
            *   可选模板列表 (从 P01 的模板中选择，支持搜索/筛选，添加)。
        *   "保存"按钮。
        *   "返回列表"按钮。
    *   **输出项：**
        *   成功/失败提示。
    *   **路径跳转：**
        *   保存成功 → P04。
        *   返回 → P04。
    *   **异常处理：**
        *   名称为空。
        *   未选择任何模板时保存。
    *   **页面字段结构 (对应 `template_set` 和 `template_set_items`)**
        *   `template_set.name`: String
        *   `template_set_items`: Array of `template_id`

### 3. Campaign 与 Task 管理 (F01, F02, F03, F04, F06, F08)

*   **P06: Campaign 列表页 (`/campaigns`)**
    *   **页面目标：** 展示所有 Campaign，进行管理和状态概览。
    *   **输入项/操作：**
        *   "创建新 Campaign"按钮。
        *   Campaign 列表：
            *   列：Campaign 名称, 开始时间, 状态 (`draft` / `active` / `paused` / `completed`), 包含Task数, 操作（查看Tasks, 编辑 - 若draft, 删除 - 若无task或draft）。
        *   筛选器 (按状态)。
        *   分页。
    *   **输出项：**
        *   Campaign 列表。
    *   **路径跳转：**
        *   点击"创建新 Campaign" → P07。
        *   点击"查看Tasks" → P08 (预设 Campaign ID 筛选)。
        *   点击"编辑" → P07 (带 Campaign 数据)。
    *   **异常处理：**
        *   列表为空。

*   **P07: Campaign 创建/编辑页 (`/campaigns/new` 或 `/campaigns/:id/edit`)**
    *   **页面目标：** 创建或编辑 Campaign 基本信息。
    *   **输入项/操作：**
        *   表单：
            *   Campaign 名称 (文本输入)。
            *   开始时间 (`start_time`) (日期时间选择器)。
        *   "保存并配置Task"按钮 (创建时) / "保存"按钮 (编辑时)。
        *   "返回列表"按钮。
    *   **输出项：**
        *   成功/失败提示。
    *   **路径跳转：**
        *   保存并配置Task → P09 (新建 Task 页面，并关联当前 Campaign)。
        *   保存 (编辑时) → P06。
    *   **页面字段结构 (对应 `campaign` 表)：**
        *   `name`: String
        *   `start_time`: Datetime

*   **P08: Task 列表页 (`/tasks` 或 `/campaigns/:campaignId/tasks`)**
    *   **页面目标：** 展示特定 Campaign 下或所有的 Task 及其状态和统计。
    *   **输入项/操作：**
        *   (若从 Campaign 进入，则 Campaign 名称作为标题/面包屑)。
        *   "创建新 Task"按钮 (若查看所有Task，需选择 Campaign；若在 Campaign 内，则自动关联)。
        *   Task 列表：
            *   列：Task 名称, 所属 Campaign, 计划发送时间 (`plan_time`), 状态 (`draft` / `scheduled` / `sending` / `finished` / `paused` / `failed`), 收件人数 (预估/实际), 发送数, 送达数, 打开数, 点击数, 操作（编辑 - 若draft/paused, 查看详情/报告, 手动重试 - 若paused/failed, 取消 - 若scheduled）。
        *   筛选器 (按状态, 按Campaign)。
        *   分页。
    *   **输出项：**
        *   Task 列表。
    *   **路径跳转：**
        *   点击"创建新 Task" → P09。
        *   点击"编辑" → P09 (带 Task 数据)。
        *   点击"查看详情/报告" → P10。
    *   **异常处理：**
        *   列表为空。

*   **P09: Task 创建/编辑页 (`/tasks/new` 或 `/tasks/:id/edit`)**
    *   **页面目标：** 配置 Task 的所有参数。 (多步骤表单或长表单)
    *   **输入项/操作：**
        *   **步骤1/区块1: 基本信息**
            *   Task 名称 (文本输入)。
            *   所属 Campaign (选择器 - 若从 `/tasks/new` 进入；只读 - 若从 Campaign 内创建或编辑)。
            *   计划发送时间 (`plan_time`) (日期时间选择器 - 默认 Campaign 的 `start_time`，可修改)。
        *   **步骤2/区块2: 收件人规则 (`recipient_rule`)** (US03.1)
            *   包含标签 (多选组件，从已有联系人标签中选择)。
            *   排除标签 (多选组件)。
            *   (MVP简化) 包含系统标签 (单选/下拉，如 `system:unopened_last_campaign`)。
            *   (MVP简化) 排除系统标签 (单选/下拉)。
            *   (可选) 预估收件人数展示。
        *   **步骤3/区块3: 模板选择 (`template_set_id`)** (US04.1)
            *   选择模板组 (下拉选择器，从 P04 创建的模板组中选择)。
            *   (可选) 预览选中模板组中的模板。
        *   "保存为草稿"按钮。
        *   "保存并设为预定"按钮 (将 Task 状态置为 `scheduled`，Campaign 状态置为 `active`)。
        *   "返回列表"按钮。
    *   **输出项：**
        *   成功/失败提示。
    *   **路径跳转：**
        *   保存后 → P08。
    *   **异常处理：**
        *   各必填项校验。
        *   收件人规则未选任何包含条件。
        *   未选择模板组。
    *   **页面字段结构 (对应 `task` 表)：**
        *   `name`: String
        *   `campaign_id`: FK
        *   `plan_time`: Datetime
        *   `recipient_rule`: JSON
        *   `template_set_id`: FK

*   **P10: Task 详情/报告页 (`/tasks/:id/report`)**
    *   **页面目标：** 展示单个 Task 的详细发送状态、统计数据和事件日志。
    *   **输入项/操作：**
        *   返回 Task 列表按钮。
        *   操作按钮 (如：导出失败名单 - 后续迭代)。
    *   **输出项：**
        *   **概览信息：** Task 名称, Campaign, 状态, 计划/实际发送时间, 使用的发件服务。
        *   **统计数据 (图表+数字)：**
            *   总收件人数。
            *   发送成功数 / 发送失败数 (API层面)。
            *   送达数 / 退信数 (基于回调)。
            *   打开数 (独立) / 打开率。
            *   点击数 (独立/总次数) / 点击率。
            *   (可选) 退订数 (基于回调)。
        *   **事件列表 (分页/筛选)：** (对应 `event_log`)
            *   联系人邮箱, 事件类型 (`send`, `delivered`, `open`, `click`, `bounce`), 时间戳, 详情 (如 bounce 原因, 点击的 URL)。
    *   **路径跳转：**
        *   返回 → P08。
    *   **异常处理：**
        *   Task 不存在。

### 4. 邮件变量管理 (新增)

*   **P11: 邮件变量管理页 (`/settings/variables`)**
    *   **页面目标：** 允许运营人员定义和管理可在邮件模板中使用的全局邮件变量。
    *   **输入项/操作：**
        *   "添加新变量"按钮。
        *   变量列表：
            *   列：变量名称 (e.g., `contact.nickname`), 显示名称, 变量来源 (e.g., "联系人昵称", "联系人标签组A"), 描述, 操作（编辑, 删除 - 若无模板使用或有提示）。
    *   **输出项：**
        *   已定义的邮件变量列表。
    *   **路径跳转：**
        *   点击"添加新变量" → P12 (模态框/新页)。
        *   点击"编辑" → P12 (带数据)。
    *   **异常处理：**
        *   列表为空。
        *   删除被使用的变量时提示。
    *   **页面字段结构 (大致思路，具体表结构待数据库设计阶段明确)：**
        *   `variable_key`: String (e.g., `contact.nickname`, `contact.tag.groupA`)
        *   `display_name`: String (e.g., "联系人昵称", "客户行业标签")
        *   `source_type`: Enum (e.g., `CONTACT_FIELD`, `CONTACT_TAG`)
        *   `source_details`: JSON (e.g., `{"field": "nickname"}`, `{"tag_prefix": "industry_"}`)
        *   `description`: String

*   **P12: 邮件变量编辑/创建页 (模态框或 `/settings/variables/new` 或 `/settings/variables/:key/edit`)**
    *   **页面目标：** 定义新的邮件变量或修改现有变量。
    *   **输入项/操作：**
        *   表单：
            *   变量键名 (`variable_key`) (用户输入，需符合 `{{...}}` 内的格式，需唯一，如 `contact.custom_field_X` 或 `user.name`)。
            *   显示名称 (用户友好，用于在编辑器中选择列表展示，如"客户生日", "当前用户名")。
            *   变量来源类型 (下拉选择)：
                *   联系人字段 (选择后，再下拉选择具体的联系人表字段如 `email`, `nickname`, `custom_field_1` 等)。
                *   联系人标签 (选择后，可能需要输入标签前缀或选择特定标签作为变量来源，最终替换为该联系人命中的此系列标签，逗号分隔)。
                *   (未来可扩展) 系统变量 (如当前日期 `system.date`)。
            *   描述 (文本域)。
        *   "保存"按钮。
    *   **输出项：**
        *   成功/失败提示。
    *   **路径跳转：**
        *   保存后返回 P11。
    *   **异常处理：**
        *   变量键名冲突或格式不正确。
        *   来源配置不完整。

## II. 超级管理员界面

### 1. 发件服务管理 (F09)

*   **P_ADMIN_01: 发件服务列表页 (`/admin/sender-services`)**
    *   **页面目标：** 管理所有 SMTP 发件服务 (极光 API)。
    *   **输入项/操作：**
        *   "添加新服务"按钮。
        *   服务列表：
            *   列：服务名称, 类型 (极光API), `daily_quota`, `used_today`, `throttle_sec`, `health_status` (`active`/`frozen`), 操作（编辑, 删除, 手动冻结/解冻）。
    *   **输出项：**
        *   发件服务列表。
    *   **路径跳转：**
        *   点击"添加新服务" → P_ADMIN_02。
        *   点击"编辑" → P_ADMIN_02 (带数据)。
    *   **异常处理：**
        *   列表为空。

*   **P_ADMIN_02: 发件服务编辑/创建页 (`/admin/sender-services/new` 或 `/admin/sender-services/:id/edit`)**
    *   **页面目标：** 配置极光 API 发件服务。
    *   **输入项/操作：**
        *   表单：
            *   服务名称 (文本输入)。
            *   服务类型 (只读：极光 API)。
            *   API Key (文本输入, 密码类型)。
            *   API Secret (文本输入, 密码类型)。
            *   每日发送上限 (`daily_quota`) (数字输入)。
            *   每秒发送限制 (`throttle_sec` 或 QPS/TPM) (数字输入)。
            *   健康状态 (`health_status`) (下拉选择: `active`/`frozen` - 创建时默认为 active)。
        *   "保存"按钮。
        *   "返回列表"按钮。
    *   **输出项：**
        *   成功/失败提示。
    *   **路径跳转：**
        *   保存后 → P_ADMIN_01。
    *   **异常处理：**
        *   必填项校验。
        *   凭证格式错误。
    *   **页面字段结构 (对应 `sender_service` 表)：**
        *   `name`: String
        *   `type`: Enum (e.g., 'jiguang')
        *   `credentials`: JSON (encrypted: { `api_key`, `api_secret` })
        *   `daily_quota`: Integer
        *   `throttle_sec`: Integer # 系统侧主动限流设置，非jiguang API参数
        *   `health_status`: Enum

### 2. 用户与发件服务关联管理 (新增)

*   **P_ADMIN_03: 用户与发件服务关联管理页 (`/admin/user-sender-bindings`)**
    *   **页面目标：** 管理哪些运营用户可以使用哪些发件服务。这主要用于在有多个发件服务，且希望对不同用户/用户组分配不同发送资源时。
    *   **输入项/操作：**
        *   用户筛选/搜索框 (通过用户名或邮箱搜索系统内的运营用户)。
        *   选中一个用户后，显示两栏：
            *   左栏：该用户已分配的发件服务列表 (服务名称, 类型)。可操作：移除。
            *   右栏：所有`active`状态发件服务列表 (服务名称, 类型)。可操作：添加。
        *   "保存对该用户的更改"按钮。
    *   **输出项：**
        *   更新后的用户-服务关联关系。
        *   成功/失败提示。
    *   **路径跳转：**
        *   无特定跳转，页面内完成操作。
    *   **异常处理：**
        *   用户不存在。
        *   服务不存在或状态不正确。
    *   **页面字段结构 (示意，可能需要中间表 `user_sender_service_access`)**
        *   `user_id`: FK
        *   `sender_service_id`: FK
        *   `can_use`: Boolean (或者直接通过记录存在与否判断)

---
文档版本: v1.1
最后更新: {{CURRENT_DATE}} (此处将由系统自动填充实际日期) 