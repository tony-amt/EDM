# REQ-002-需求确认清单

## 关键业务逻辑确认

### 1. 群发任务调度机制确认

#### 1.1 子任务生成逻辑
**问题**：在创建子任务时，如何确定"唯一的发信人（发信人名称+发信服务组成的发信地址）"？

**需要确认**：
- 发信人名称是否从群发任务中指定的"单一发信人名称"获取？
- 发信服务是否通过路由算法实时分配？
- 发信地址的最终格式是什么？（如：`发信人名称@发信服务域名`）

**产品经理反馈**
好问题，我需要你再补充到需求文档中的：
- 发信人管理，支持用户自行添加/删除发信人名称
- 创建任务时，需要关联已创建的发信人
- 发信人名称全用户唯一，这里会涉及到后续生成唯一的发信邮箱地址问题
- 一个任务中，只能指定一个发信人（名称）
- 发信地址最终格式是 发信人名称@发信服务域名。 所以一个任务只有一个发信人，但会有多个发信地址（取决于子任务匹配了多少个发信服务及对应的发信域名）。这里在发信服务中可能要补充一下发信域名的输入框，否则在生成发信地址时，会找不到发信域名

#### 1.2 任务执行完成判定
**问题**：主任务完成的条件描述为"所有子任务都发送成功后，主任务才算发送完成"

**需要确认**：
- 如果有子任务发送失败，主任务状态如何处理？
- 是否需要支持"部分成功"的任务状态？
- 失败的子任务是否需要重试机制？

**产品经理反馈**
很棒的边界性问题，我来澄清一下：
- 发送只在乎是否发送，如果有发送失败，也识为已经发送，再进行下一轮子任务的匹配，全部子任务都执行之后（即便有失败的），也会视为任务完成。
- 任务会单独统计本批次失败数
- 失败的子任务暂不支持重试机制，但需要异常冻结+提醒机制。这个主要针对发信服务的，如果连续发信失败达到10次，触发异常冻结，需要管理员检查后手动恢复

### 2. 发信路由机制确认

#### 2.1 路由判断逻辑细节
**问题**：路由判断中"用户关联的发信服务非时间间隔中"的具体实现

**需要确认**：
- 发信间隔是否按发信服务维度计算？（即每个发信服务有独立的间隔计时）
- 间隔计时的起始点是什么？（发送成功时刻？发送请求时刻？）
- 多个用户使用同一发信服务时，间隔时间如何共享？

**产品经理反馈**
这里的逻辑确实比较绕，请充分理解后再设计
- 发信间隔的确按发信服务维度计算，即便多个用户用到同一个发信服务，也要遵循发信服务的发信频率（在发信服务管理中有这个配置）
- 计时起点为发送请求时刻
- 多个用户使用同一发信服务时，按照子任务抢占排队，先到先得，发信服务在每一个间隔内，只处理一个用户的子任务。为权衡公平机制，可以加入用户排队轮询机制，但如果用户在进行其他任务时，发信服务不会停下来“等”用户


#### 2.2 服务分配策略
**问题**：轮询机制的具体实现方式

**需要确认**：
- "按任务创建时间轮询"是指什么？（任务级轮询？用户级轮询？）
- 如果用户A的任务正在执行，用户B的任务是否需要等待？
- 同一用户的多个任务之间如何调度？

**产品经理反馈**
- 分为任务级轮询和用户级轮询
- 用户A的任务正在执行，用户B的任务不需要等待，大家抢占共同的发信服务，发信服务在排队请求中，可以兼顾历史发送记录，照顾最近还没轮到的用户
- 同一用户的多个任务之间也不用等待，在同一个发信服务中，按照任务创建时间顺序来轮询

### 3. 额度管理机制确认

#### 3.1 预扣减逻辑
**问题**：群发任务保存时的额度预扣减机制

**需要确认**：
- 预扣减的数量是否等于"计划发送人数"？
- 如果任务执行过程中有发送失败，如何处理额度回退？
- 用户修改已保存的群发任务时，如何处理额度调整？

**产品经理反馈**
- 是的，预扣减额度等于计划发送人数
- 发送失败暂不回退额度
- 群发任务启动后不允许修改，可以暂停，可以取消。群发任务启动后开始扣减额度，暂停时不恢复，取消时，根据剩余的发信计划来恢复额度。已经取消的任务无法再激活，只能创建新的任务重新进行

#### 3.2 并发原子性控制
**问题**：多用户并发时的额度扣减原子性

**需要确认**：
- 是否使用数据库事务？分布式锁？还是其他机制？
- 如果发信服务额度不足，多个用户的任务如何处理优先级？
- 额度不足时的任务排队机制如何设计？

**产品经理反馈**
- 技术问题你来推荐最佳策略
- 发信服务额度按照多个用户多个任务的子任务来实时扣减，额度不足时，子任务请求会被驳回，不存在额度不足时的优先级处理。而发信服务在处理子任务的优先级时，策略同上，兼顾多用户轮询和多任务轮询机制。
- 额度不足时，子任务优先流转到其他发信服务，如果该用户可用的发信服务额度都不足，则暂停等待额度恢复，逻辑和前面的一致

### 4. 用户管理确认

#### 4.1 用户权限模型
**问题**：系统中是否只有"管理员"和"普通用户"两种角色？

**需要确认**：
- 是否需要更细粒度的权限控制？
- 普通用户是否可以查看自己的发信服务使用情况？
- 是否需要用户组概念？

**产品经理反馈**
- 只提供管理员和普通用户两个角色。其中管理员只有一个，就是我们之前测试用的admin，由管理员来创建多个普通用户，并分配用户额度（未来会再迭代用户主动支付购买额度）
- 普通用户不需要关心自己的可用发信服务概念，只需要关心自己的可用剩余额度。所以建议用户的dashboard显示最新的发信剩余额度
- 不考虑用户组，同一个用户可多个设备同时登录在线

#### 4.2 用户可用发信服务管理
**问题**："每个用户只允许一条关联记录"的约束理解

**需要确认**：
- 是指用户在`用户-发信服务关联表`中只能有一条记录？
- 这条记录可以关联多个发信服务？
- 如果要调整用户的可用服务，是更新记录还是删除重建？

**产品经理反馈**
- 是的，关联表中，用户只能有一条记录。但设计模型上，用户和发信服务是多对多关系，即这个用户使用了的发信服务，其他用户也可以使用
- 这条记录本身，用户和发信服务是1对多关系
- 如果要调整，更新记录

### 5. 系统集成确认

#### 5.1 与现有系统的集成
**问题**：本次功能如何与已有的群发任务CRUD功能集成？

**需要确认**：
- 现有的群发任务表结构是否需要调整？
- 现有的创建群发任务流程是否需要增加额度检查逻辑？
- 任务状态字段是否需要扩展？

**产品经理反馈**
- 现有的群发任务只在上一阶段完成基本功能，跑通流程，本质还是一套功能。所以现有的群发任务，需要根据本次的需求进行迭代优化
- 创建任务流程需要增加额度检查逻辑
- 任务状态按本次最新需求来扩展

#### 5.2 数据库设计考虑
**问题**：需要新增哪些数据表？

**需要确认**：
- 是否需要新增：用户表、发信服务表、用户-发信服务关联表、子任务表？
- 现有表结构是否需要调整？
- 数据迁移策略是什么？

**产品经理反馈**
- 用户表现在应该就有，我们的管理员应该就添加在上面的。只是这个表可能要扩充字段，比如增加用户角色等
- 还需要新增的表：发信服务表、关联表、子任务表、用户额度记录表、其他暂时想不到了，实现的时候根据方案再评估
- 现有表结构根据需求来调整
- 目前都是测试数据，不考虑数据迁移工作。如果因为数据表变更引起兼容问题，可以直接把测试数据删掉

### 6. 技术实现确认

#### 6.1 定时任务机制
**问题**：群发任务的定时监听机制如何实现？

**需要确认**：
- 是否使用定时轮询数据库？
- 轮询频率如何确定？
- 如何处理大量定时任务对系统性能的影响？

**产品经理反馈**
- 还是偏技术型的问题，需要你来进一步分析给出策略，轮询频率理论上每秒更新，需要评估性能和损耗问题

#### 6.2 实时性要求
**问题**：额度显示的"实时性"要求程度

**需要确认**：
- 是否需要做到秒级实时？
- 是否可以接受分钟级的延迟？
- 前端页面是否需要自动刷新机制？

**产品经理反馈**
- 后端额度需要秒级实时，避免并发导致额度控制问题。前端显示可以分钟级
- 前端页面不增加自动刷新，增加手动刷新按钮。这个不那么重要，不要过多损耗前端运行的资源

---

## 优先级确认

### 高优先级确认项（影响核心功能）
1. 子任务生成逻辑
2. 发信路由判断逻辑
3. 额度预扣减机制
4. 用户-发信服务关联关系

### 中优先级确认项（影响用户体验）
1. 任务完成判定逻辑
2. 服务分配策略
3. 权限模型设计

### 低优先级确认项（影响系统优化）
1. 定时任务实现方式
2. 实时性要求程度

**产品经理反馈**
- 同意优先级
- 但本次的需求是整个系统的核心，需要完整实现

---

**请您针对以上问题进行确认，我们将基于您的反馈进一步完善需求文档，确保技术实现的准确性。**

**文档版本**: v1.0  
**创建日期**: 2025-01-27  
**负责人**: 项目控制中心 