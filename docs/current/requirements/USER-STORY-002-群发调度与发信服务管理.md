# USER-STORY-002-群发调度与发信服务管理

## 1. 发信人管理用户故事

### F14-US01: 创建发信人
**角色**: 营销运营人员  
**行为**: 我想要创建新的发信人名称  
**目的**: 为群发任务提供发信人选择，建立品牌发信身份  

**验收条件**:
- ✅ 用户可以输入发信人名称
- ✅ 系统检查发信人名称在全系统范围内的唯一性
- ✅ 发信人名称不能为空
- ✅ 创建成功后显示在发信人列表中
- ✅ 重复名称时显示错误提示

**边缘场景**:
- 发信人名称包含特殊字符
- 发信人名称过长或过短
- 网络中断时的保存状态

**Story编号**: F14-US01

---

### F14-US02: 删除发信人
**角色**: 营销运营人员  
**行为**: 我想要删除不再使用的发信人名称  
**目的**: 清理无用的发信人，保持列表整洁  

**验收条件**:
- ✅ 用户可以选择发信人进行删除
- ✅ 删除前检查是否有未完成任务正在使用该发信人
- ✅ 有关联任务时显示警告并阻止删除
- ✅ 确认删除后发信人从列表中移除
- ✅ 删除操作需要二次确认

**边缘场景**:
- 删除正在被活跃任务使用的发信人
- 删除系统中唯一的发信人

**Story编号**: F14-US02

---

## 2. 群发任务调度用户故事

### F15-US01: 任务定时调度
**角色**: 系统调度引擎  
**行为**: 我需要按计划时间启动群发任务  
**目的**: 确保群发任务按时自动执行  

**验收条件**:
- ✅ 每秒检查待执行的群发任务
- ✅ 到达计划时间的任务自动启动
- ✅ 任务状态从"待执行"更新为"执行中"
- ✅ 记录任务启动日志
- ✅ 支持多个任务并发执行

**边缘场景**:
- 系统重启后的任务恢复
- 任务计划时间已过的处理
- 大量任务同时到期的处理

**Story编号**: F15-US01

---

### F15-US02: 任务状态管理
**角色**: 营销运营人员  
**行为**: 我想要控制群发任务的执行状态  
**目的**: 灵活管理任务执行进度，应对突发情况  

**验收条件**:
- ✅ 用户可以暂停正在执行的任务
- ✅ 用户可以恢复已暂停的任务
- ✅ 用户可以取消未完成的任务
- ✅ 任务启动后不允许修改配置
- ✅ 状态变更立即在界面上反映

**边缘场景**:
- 任务执行过程中的网络中断
- 同时多人操作同一任务
- 已完成任务的重复操作

**Story编号**: F15-US02

---

### F16-US01: 子任务自动生成
**角色**: 系统调度引擎  
**行为**: 我需要为群发任务生成子任务  
**目的**: 将群发任务分解为可执行的最小单元  

**验收条件**:
- ✅ 为每个收信人生成唯一的子任务
- ✅ 子任务包含唯一ID、收信人、邮件内容、发信地址
- ✅ 根据路由算法分配发信服务
- ✅ 生成发信地址（发信人名称@发信服务域名）
- ✅ 子任务状态初始化为"待发送"

**边缘场景**:
- 收信人列表为空的任务
- 无可用发信服务的情况
- 邮件内容渲染失败

**Story编号**: F16-US01

---

### F16-US02: 子任务状态跟踪
**角色**: 系统调度引擎  
**行为**: 我需要跟踪每个子任务的执行状态  
**目的**: 监控发送进度，统计任务完成情况  

**验收条件**:
- ✅ 子任务状态实时更新：待发送→发送中→已发送/发送失败
- ✅ 记录子任务开始和结束时间
- ✅ 发送失败时记录失败原因
- ✅ 统计主任务的整体进度
- ✅ 所有子任务完成后主任务状态更新为"已完成"

**边缘场景**:
- 子任务执行超时
- 发信服务返回异常状态
- 子任务执行过程中系统重启

**Story编号**: F16-US02

---

## 3. 发信服务管理用户故事

### F18-US01: 创建发信服务
**角色**: 系统管理员  
**行为**: 我想要添加新的发信服务配置  
**目的**: 扩展系统发信能力，提供更多发信通道  

**验收条件**:
- ✅ 输入服务名称、发信域名、API凭证
- ✅ 设置每日发送额度和发信频率
- ✅ 配置额度重置时间（HH:MM格式）
- ✅ 服务创建后默认为启用状态
- ✅ API凭证显示时加密处理

**边缘场景**:
- API凭证验证失败
- 发信域名格式错误
- 额度重置时间设置不合理

**Story编号**: F18-US01

---

### F18-US02: 发信服务状态监控
**角色**: 系统管理员  
**行为**: 我想要监控发信服务的实时状态  
**目的**: 及时发现服务异常，确保发信稳定性  

**验收条件**:
- ✅ 实时显示每日剩余额度
- ✅ 显示服务可用状态（启用/禁用/冻结）
- ✅ 连续失败10次自动冻结服务
- ✅ 显示当前发信频率冻结状态
- ✅ 按计划时间自动重置每日额度

**边缘场景**:
- 额度重置时的并发操作
- 冻结状态下的用户操作
- 异常冻结的恢复机制

**Story编号**: F18-US02

---

### F18-US03: 手工调整服务额度
**角色**: 系统管理员  
**行为**: 我想要手工调整发信服务的当日剩余额度  
**目的**: 灵活应对业务需求变化，优化发信资源分配  

**验收条件**:
- ✅ 管理员可以增加或减少当日剩余额度
- ✅ 调整后立即生效并反映在监控页面
- ✅ 记录额度调整历史和操作人
- ✅ 调整值不能为负数
- ✅ 调整操作需要确认

**边缘场景**:
- 调整额度时有任务正在执行
- 调整为0时的任务暂停处理
- 调整额度超过系统限制

**Story编号**: F18-US03

---

## 4. 智能路由用户故事

### F20-US01: 路由条件检查
**角色**: 系统路由引擎  
**行为**: 我需要检查子任务的发送条件  
**目的**: 确保子任务在合适的条件下发送，避免发送失败  

**验收条件**:
- ✅ 检查用户发信额度（>0）
- ✅ 检查用户关联的发信服务可用性
- ✅ 检查发信服务每日剩余额度（>0）
- ✅ 检查发信服务非冻结状态
- ✅ 条件不满足时暂停任务并提示具体原因

**边缘场景**:
- 检查过程中状态发生变化
- 多个条件同时不满足
- 用户权限变更影响路由

**Story编号**: F20-US01

---

### F20-US02: 服务分配策略
**角色**: 系统路由引擎  
**行为**: 我需要为子任务分配合适的发信服务  
**目的**: 实现负载均衡，确保发信服务公平使用  

**验收条件**:
- ✅ 实现用户级轮询机制
- ✅ 实现任务级轮询机制
- ✅ 优先分配剩余额度多的服务
- ✅ 避免单一用户独占服务资源
- ✅ 服务不可用时自动切换到其他服务

**边缘场景**:
- 所有可用服务都处于冻结状态
- 用户可用服务列表动态变更
- 高并发时的服务分配冲突

**Story编号**: F20-US02

---

## 5. 用户管理用户故事

### F22-US01: 创建用户账户
**角色**: 系统管理员  
**行为**: 我想要创建新的用户账户  
**目的**: 为营销团队成员提供系统访问权限  

**验收条件**:
- ✅ 输入用户名、邮箱、密码
- ✅ 设置用户角色（管理员/普通用户）
- ✅ 分配初始发信额度
- ✅ 用户名和邮箱唯一性检查
- ✅ 密码加密存储

**边缘场景**:
- 用户名或邮箱重复
- 密码强度不符合要求
- 初始额度设置为负数

**Story编号**: F22-US01

---

### F22-US02: 用户Dashboard显示
**角色**: 普通用户  
**行为**: 我想要查看自己的账户信息和剩余额度  
**目的**: 了解自己的发信权限，合理安排发信计划  

**验收条件**:
- ✅ 显示当前用户名和邮箱
- ✅ 实时显示剩余发信额度
- ✅ 显示最近登录时间
- ✅ 支持手动刷新额度信息
- ✅ 额度不足时显示醒目提醒

**边缘场景**:
- 额度实时更新延迟
- 多设备同时登录的数据同步
- 权限变更后的页面更新

**Story编号**: F22-US02

---

### F23-US01: 额度预扣减
**角色**: 系统  
**行为**: 我需要在用户保存群发任务时预扣减额度  
**目的**: 防止用户超额使用，保证系统额度控制的准确性  

**验收条件**:
- ✅ 任务保存时检查用户剩余额度
- ✅ 额度不足时阻止任务保存并提示
- ✅ 额度充足时按计划发送人数预扣减
- ✅ 扣减操作具有原子性
- ✅ 记录额度扣减历史

**边缘场景**:
- 保存过程中其他操作消耗额度
- 任务保存失败时的额度回退
- 并发保存任务时的额度冲突

**Story编号**: F23-US01

---

### F23-US02: 任务取消额度回退
**角色**: 系统  
**行为**: 我需要在用户取消任务时回退剩余额度  
**目的**: 合理利用用户额度，避免额度浪费  

**验收条件**:
- ✅ 任务取消时计算剩余未发送数量
- ✅ 按剩余数量回退用户额度
- ✅ 回退操作立即生效
- ✅ 记录额度回退历史和原因
- ✅ 回退后用户可继续创建新任务

**边缘场景**:
- 取消正在发送中的任务
- 取消已部分完成的任务
- 取消操作的并发安全性

**Story编号**: F23-US02

---

## 6. 用户服务关联管理用户故事

### F24-US01: 分配用户可用服务
**角色**: 系统管理员  
**行为**: 我想要为用户分配可用的发信服务  
**目的**: 控制用户的发信通道权限，实现资源精细化管理  

**验收条件**:
- ✅ 选择单一用户和多个发信服务
- ✅ 建立用户与服务的关联关系
- ✅ 每个用户只允许一条关联记录
- ✅ 支持更新已有关联关系
- ✅ 关联生效后用户可使用对应服务

**边缘场景**:
- 用户已有关联关系的处理
- 分配不存在的发信服务
- 分配已禁用的发信服务

**Story编号**: F24-US01

---

### F24-US02: 更新用户服务关联
**角色**: 系统管理员  
**行为**: 我想要调整用户可用的发信服务列表  
**目的**: 根据业务变化动态调整用户权限  

**验收条件**:
- ✅ 选择已有关联的用户
- ✅ 修改用户关联的发信服务列表
- ✅ 更新操作立即生效
- ✅ 移除的服务不再对用户可用
- ✅ 新增的服务立即对用户可用

**边缘场景**:
- 移除用户正在使用的发信服务
- 更新为空的服务列表
- 更新过程中用户正在创建任务

**Story编号**: F24-US02

---

**文档版本**: v1.0  
**创建日期**: 2025-01-27  
**负责人**: 用户故事Agent 