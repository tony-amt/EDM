name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install frontend dependencies
      run: |
        cd src/frontend
        npm ci
    
    - name: Build frontend
      env:
        NODE_ENV: production
        REACT_APP_API_BASE_URL: /api
      run: |
        cd src/frontend
        npm run build
    
    - name: Create deployment package
      run: |
        mkdir -p deploy-package
        cp -r src/frontend/build deploy-package/frontend-build
        cp -r src/backend deploy-package/backend
        cp docker-compose.yml deploy-package/
        tar -czf edm-${{ github.ref_name }}.tar.gz deploy-package/
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p /tmp/edm-deploy
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -d "/opt/edm" ]; then
            sudo cp -r /opt/edm /tmp/edm-backup-$(date +%Y%m%d-%H%M%S)
          fi
          
          echo "âœ… å¤‡ä»½å®Œæˆï¼Œå‡†å¤‡éƒ¨ç½²ç‰ˆæœ¬: ${{ github.ref_name }}"
    
    - name: Upload deployment package
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "edm-${{ github.ref_name }}.tar.gz"
        target: "/tmp/edm-deploy/"
    
    - name: Execute deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /tmp/edm-deploy
          
          # è§£å‹éƒ¨ç½²åŒ…
          tar -xzf edm-${{ github.ref_name }}.tar.gz
          
          # åœæ­¢ç°æœ‰å®¹å™¨
          docker stop edm-frontend-prod || true
          docker rm edm-frontend-prod || true
          
          # æ„å»ºæ–°çš„å‰ç«¯é•œåƒ
          cd deploy-package
          cat > Dockerfile.frontend << 'EOF'
          FROM nginx:alpine
          COPY frontend-build /usr/share/nginx/html
          EXPOSE 80
          CMD ["nginx", "-g", "daemon off;"]
          EOF
          
          # æ„å»ºé•œåƒ
          docker build -f Dockerfile.frontend -t edm-frontend:${{ github.ref_name }} .
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker run -d \
            --name edm-frontend-prod \
            --network edm_edm-network \
            --restart unless-stopped \
            edm-frontend:${{ github.ref_name }}
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          for i in {1..5}; do
            if curl -f -s https://tkmail.fun/api/health > /dev/null 2>&1; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            elif [ $i -eq 5 ]; then
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›æ»š"
              docker stop edm-frontend-prod || true
              docker rm edm-frontend-prod || true
              # è¿™é‡Œå¯ä»¥æ·»åŠ å›æ»šé€»è¾‘
              exit 1
            else
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/5)"
              sleep 10
            fi
          done
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/edm-deploy
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼ç‰ˆæœ¬: ${{ github.ref_name }}"
    
    - name: Notify deployment success
      if: success()
      run: |
        echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ"
        echo "ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "æ—¶é—´: $(date)"
        echo "URL: https://tkmail.fun"
    
    - name: Notify deployment failure
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥"
        echo "ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "æ—¶é—´: $(date)"
        echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶è€ƒè™‘æ‰‹åŠ¨å›æ»š" 